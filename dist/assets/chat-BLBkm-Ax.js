const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/story-services-CTDJFou-.js","assets/config-CMljicwL.js"])))=>i.map(i=>d[i]);
import{supabaseConfig as w}from"./config-CMljicwL.js";import{_ as k}from"./preload-helper-D7HrI6pR.js";import{createClient as W}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const d={},v=(d==null?void 0:d.VITE_EDGE_ANALYTICS_URL)||"",Y=((d==null?void 0:d.VITE_USE_CHAT_MOCKS)??"true")==="true",A="guest-child",$="sqh_chat_transcripts_v1",q="sqh_analytics_queue_v1";let x=null,h=null;function F(){var e,t;return!!((e=w)!=null&&e.url&&((t=w)!=null&&t.anonKey))}function u(){return F()?(x||(x=W(w.url,w.anonKey)),x):null}function c(){return Y?!0:!F()}function J(){return c()}async function i(){if(h)return h;const e=await fetch(new URL("/assets/mockChatData-ChBBNlBd.json",import.meta.url));if(!e.ok)throw new Error("Unable to load mock chat data");return h=await e.json(),h}async function G(){if(c())return(await i()).topics||[];const e=u();if(!e)return(await i()).topics||[];try{const{data:t,error:n}=await e.from("topics").select("*").eq("enabled",!0).order("name");if(n)throw n;return t||[]}catch(t){return console.warn("[chat] Supabase topics fetch failed, reverting to mock data",t),(await i()).topics||[]}}async function Q(e){if(!e)throw new Error("topicId is required");if(c())return(await i()).topics.find(o=>o.id===e)||null;const t=u();if(!t)return(await i()).topics.find(o=>o.id===e)||null;try{const{data:n,error:o}=await t.from("topics").select("*").eq("id",e).eq("enabled",!0).maybeSingle();if(o||!n)throw o||new Error("topic not found");return n}catch(n){return console.warn("[chat] Supabase topic fetch failed, reverting to mock data",n),(await i()).topics.find(s=>s.id===e)||null}}function E(e,t){return new Promise(async n=>{var B;const s=(B=(await i()).responses)==null?void 0:B[e];if(!s){n((s==null?void 0:s.default)||"That's a great question! I'm here to help you learn. What else would you like to know? ðŸ¤”");return}const r=t.toLowerCase();let l=null;for(const[j,V]of Object.entries(s.patterns||{}))if(new RegExp(j,"i").test(r)){l=V;break}const K=l||s.default||"That's a great question! I'm here to help you learn. What else would you like to know? ðŸ¤”";setTimeout(()=>{n(K)},1e3+Math.random()*1e3)})}async function z(e,t,n={}){if(!(await X(t)).safe)return{role:"ai",content:"I can't answer that question right now. Would you like to ask a parent or teacher for help?",timestamp:new Date().toISOString(),safetyFlagged:!0};if(c())return{role:"ai",content:await E(e,t),timestamp:new Date().toISOString(),safetyFlagged:!1};const s=u();if(!s)return{role:"ai",content:await E(e,t),timestamp:new Date().toISOString(),safetyFlagged:!1};try{const{data:r,error:l}=await s.rpc("get_ai_response",{p_topic_id:e,p_message:t,p_context:n});if(l)throw l;return{role:"ai",content:r.response||"I'm not sure how to answer that. Can you try asking it differently?",timestamp:new Date().toISOString(),safetyFlagged:!1}}catch(r){return console.warn("[chat] Supabase AI call failed, reverting to mock",r),{role:"ai",content:await E(e,t),timestamp:new Date().toISOString(),safetyFlagged:!1}}}async function X(e){if(c())return{safe:!0};const t=u();if(!t)return{safe:!0};try{const{data:n,error:o}=await t.rpc("check_message_safety",{p_message:e});if(o)throw o;return{safe:(n==null?void 0:n.safe)??!0,reason:n==null?void 0:n.reason}}catch(n){return console.warn("[chat] Safety filter check failed, defaulting to safe",n),{safe:!0}}}function P(){if(typeof window>"u")return{};try{const e=window.localStorage.getItem($);return e?JSON.parse(e):{}}catch(e){return console.warn("[chat] Unable to read transcript store",e),{}}}function Z(e){if(!(typeof window>"u"))try{window.localStorage.setItem($,JSON.stringify(e))}catch(t){console.warn("[chat] Unable to write transcript store",t)}}function N(e,t){if(!e)throw new Error("sessionId is required");const n=P();n[e]={...t,updatedAt:new Date().toISOString()},Z(n);const o=u();o&&!c()&&o.from("chat_sessions").upsert({session_id:e,child_id:t.childId||A,topic_id:t.topicId,messages:t.messages,context:t.context,updated_at:new Date().toISOString()}).catch(s=>{console.warn("[chat] Supabase transcript save failed",s)})}function ee(e){return e&&P()[e]||null}function te(){return`chat_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function ne(){if(typeof window>"u")return[];try{const e=window.localStorage.getItem(q);return e?JSON.parse(e):[]}catch(e){return console.warn("[chat] Failed to read analytics queue",e),[]}}function ae(e){if(!(typeof window>"u"))try{window.localStorage.setItem(q,JSON.stringify(e))}catch(t){console.warn("[chat] Failed to update analytics queue",t)}}function oe(e){const t=ne();t.push(e),ae(t)}async function se(e){if(!v)return!1;try{return(await fetch(v,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok}catch(t){return console.warn("[chat] Edge analytics call failed",t),!1}}async function f(e,t={}){const n={eventType:`chat_${e}`,payload:{...t,childId:A},timestamp:new Date().toISOString()};if(v&&await se(n))return;oe(n);const o=u();o&&!c()&&o.from("analytics_events").insert({event_type:n.eventType,payload:n.payload,occurred_at:n.timestamp}).catch(s=>{console.warn("[chat] Supabase analytics insert failed",s)})}const L=new URLSearchParams(window.location.search),b=L.get("topicId"),re=L.get("storyRef"),ie=L.get("panelId"),a={topicId:null,topic:null,messages:[],isLoading:!1,context:{storyRef:re||null,panelId:ie||null},sessionId:null,storyTitle:null},y=document.getElementById("topicPicker"),D=document.getElementById("chatSession");document.getElementById("chatHeader");const ce=document.getElementById("topicName"),m=document.getElementById("contextBadge"),p=document.getElementById("chatWindow"),I=document.getElementById("messageInput"),T=document.getElementById("sendBtn"),S=document.getElementById("quickPrompts");document.getElementById("safetyBanner");const le=document.getElementById("escalationBtn"),de=document.getElementById("backBtn"),O=document.getElementById("offlineBanner");function _(){if(!O)return;const e=J()||navigator.onLine===!1;O.classList.toggle("hidden",!e)}function ue(e){y.innerHTML="",e.forEach(t=>{const n=document.createElement("div");n.className="bg-gradient-to-br from-indigo-700/40 to-fuchsia-600/40 backdrop-blur-xl border border-white/20 rounded-3xl p-6 cursor-pointer hover:from-indigo-700/50 hover:to-fuchsia-600/50 transition shadow-[0_0_30px_rgba(155,55,255,0.25)]",n.innerHTML=`
      <div class="flex justify-center mb-4">
        <div class="bg-white/20 p-4 rounded-full">
          <div class="text-6xl">${t.icon}</div>
        </div>
      </div>
      <h3 class="font-fredoka text-2xl text-white mb-2 text-center">${t.name}</h3>
      <p class="text-white/80 text-sm mb-4 text-center">${t.description}</p>
      <button class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-2xl hover:from-purple-600 hover:to-pink-600 transition shadow-lg">
        Start Chat
      </button>
    `,n.querySelector("button").addEventListener("click",()=>{window.location.href=`./index.html?topicId=${t.id}`}),y.appendChild(n)})}function pe(e,t=!1){const n=document.createElement("div"),o=e.role==="user";return n.className=`flex ${o?"justify-end":"justify-start"} mb-4`,t&&!o?n.innerHTML=`
      <div class="max-w-[80%] bg-[#E8D9FF] border-2 border-[#C8AFFF] text-slate-800 rounded-3xl px-5 py-3 shadow-lg">
        <div class="flex items-center gap-2">
          <div class="flex gap-1">
            <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
          </div>
          <span class="text-sm text-purple-700 font-semibold">Thinking...</span>
        </div>
      </div>
    `:n.innerHTML=`
      <div class="max-w-[80%] ${o?"bg-gradient-to-br from-purple-500 to-pink-500 text-white font-bold":"bg-[#E8D9FF] border-2 border-[#C8AFFF] text-slate-800"} rounded-3xl px-5 py-3 shadow-lg">
        <p class="text-sm leading-relaxed">${e.content}</p>
      </div>
    `,n}function g(){p.innerHTML="",a.messages.forEach((e,t)=>{const n=a.isLoading&&t===a.messages.length-1&&e.role==="ai"&&e.content==="...";p.appendChild(pe(e,n))}),p.scrollTop=p.scrollHeight}function fe(){var e;if(!((e=a.topic)!=null&&e.quickPrompts)){S.innerHTML="";return}S.innerHTML="",a.topic.quickPrompts.forEach((t,n)=>{const o=document.createElement("button");o.className="px-4 py-2 bg-white/10 border border-white/20 text-white rounded-full text-sm font-semibold hover:bg-white/20 transition",o.textContent=t,o.addEventListener("click",async()=>{I.value=t,await f("quick_prompt_used",{topicId:a.topicId,promptIndex:n}),C()}),S.appendChild(o)})}function U(){if(!a.context.storyRef){m.classList.add("hidden");return}m.classList.remove("hidden");let e="";if(a.context.panelId){const n=a.context.panelId.replace(/^panel-?/i,"").replace(/^panel/i,"");n&&(e=` - Panel ${n}`)}const t=a.storyTitle?`From: ${a.storyTitle}${e}`:`From story: ${a.context.storyRef}${e}`;m.textContent=t,m.onclick=()=>{if(a.context.storyRef){let n="";if(a.context.panelId){const o=a.context.panelId.replace(/^panel-?/i,"").replace(/^panel/i,"");o&&(n=`?panel=${o}`)}window.location.href=`/stories/${a.context.storyRef}/read${n}`}}}async function C(){var s;const e=I.value.trim();if(!e||a.isLoading)return;const t={role:"user",content:e,timestamp:new Date().toISOString()};a.messages.push(t),g(),I.value="",T.disabled=!0,a.isLoading=!0;const n={role:"ai",content:"...",timestamp:new Date().toISOString()};a.messages.push(n),g(),await f("message_sent",{topicId:a.topicId,messageLength:e.length,hasContext:!!a.context.storyRef});const o=await z(a.topicId,e,a.context);a.messages.pop(),a.messages.push(o),g(),a.isLoading=!1,T.disabled=!1,N(a.sessionId,{topicId:a.topicId,messages:a.messages,context:a.context,childId:"guest-child",createdAt:((s=a.messages[0])==null?void 0:s.timestamp)||new Date().toISOString()})}async function he(e){if(e)try{const{getStoryById:t}=await k(async()=>{const{getStoryById:o}=await import("./story-services-CTDJFou-.js");return{getStoryById:o}},__vite__mapDeps([0,1])),n=await t(e);n&&(a.storyTitle=n.title,U())}catch(t){console.warn("[chat] Could not load story title",t)}}async function me(){var n;if(!b){const o=await G();ue(o),y.classList.remove("hidden"),D.classList.add("hidden");return}y.classList.add("hidden"),D.classList.remove("hidden");const e=await Q(b);if(!e){p.innerHTML=`
      <div class="text-center py-12">
        <p class="text-white text-lg mb-4">Topic not found. Please go back and select a topic.</p>
        <button onclick="window.location.href='./index.html'" class="px-6 py-3 bg-purple-600 text-white rounded-2xl font-semibold hover:bg-purple-500 transition">
          Go to Topic List
        </button>
      </div>
    `;return}a.topicId=b,a.topic=e,a.sessionId=te(),ce.textContent=e.name;const t=ee(a.sessionId);if(t&&t.messages)a.messages=t.messages;else{const o={role:"ai",content:`Hi! I'm here to help you learn about ${e.name}! ${e.icon} What would you like to know?`,timestamp:new Date().toISOString()};a.messages=[o]}g(),fe(),U(),a.context.storyRef&&await he(a.context.storyRef),await f("chat_started",{topicId:a.topicId,storyRef:a.context.storyRef,panelId:a.context.panelId}),N(a.sessionId,{topicId:a.topicId,messages:a.messages,context:a.context,childId:"guest-child",createdAt:((n=a.messages[0])==null?void 0:n.timestamp)||new Date().toISOString()})}T.addEventListener("click",C);I.addEventListener("keypress",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),C())});de.addEventListener("click",async()=>{if(a.sessionId&&a.topicId&&await f("chat_session_ended",{topicId:a.topicId,messageCount:a.messages.length}),a.context.storyRef){let e="";if(a.context.panelId){const t=a.context.panelId.replace(/^panel-?/i,"").replace(/^panel/i,"");t&&(e=`?panel=${t}`)}window.location.href=`/stories/${a.context.storyRef}/read${e}`}else window.location.href="./index.html"});le.addEventListener("click",()=>{f("escalation_clicked",{topicId:a.topicId}),alert("That's a great question! You can ask a parent or teacher for help with this. They'll be happy to explain it to you! ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦")});_();window.addEventListener("online",_);window.addEventListener("offline",_);me();const H=async()=>{try{const{createClient:e}=await k(async()=>{const{createClient:n}=await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm");return{createClient:n}},[]),{supabaseConfig:t}=await k(async()=>{const{supabaseConfig:n}=await import("./config-CMljicwL.js");return{supabaseConfig:n}},[]);if(t!=null&&t.url&&(t!=null&&t.anonKey)){const n=e(t.url,t.anonKey),{error:o}=await n.auth.signOut();if(o)throw o}}catch{console.log("Supabase logout skipped (mock mode)")}localStorage.clear(),sessionStorage.clear(),window.location.href="../auth/auth.html"};var R;(R=document.getElementById("logoutBtn"))==null||R.addEventListener("click",H);var M;(M=document.getElementById("logoutBtnMobile"))==null||M.addEventListener("click",H);
