import"./config-ClyacVFi.js";import{getStoryById as x,getStoryProgressSummary as C,logAnalyticsEvent as P}from"./story-services-DPdubSP2.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const p=new URLSearchParams(window.location.search),l=p.get("storyId"),c=document.getElementById("storyTitle"),d=document.getElementById("storySummary"),B=document.getElementById("storyLongSummary"),E=document.getElementById("storyCover"),w=document.getElementById("storyTopic"),v=document.getElementById("storyReadingLevel"),S=document.getElementById("storyTime"),s=document.getElementById("progressLabel"),r=document.getElementById("startStoryBtn"),i=document.getElementById("resumeStoryBtn"),I=document.getElementById("panelPreview"),f=document.getElementById("panelPreviewTemplate"),L=document.getElementById("openChatBtn");function T(t){I.innerHTML="",t.slice(0,4).forEach((n,e)=>{const o=f.content.cloneNode(!0);o.querySelector("[data-panelId]").textContent=`#${e+1}`,o.querySelector("[data-panelText]").textContent=n.narration,I.appendChild(o)})}function b(t,n){const e=(t==null?void 0:t.lastPanelIndex)>0;!!(t!=null&&t.completedAt)?s.textContent="Completed â€“ great job!":e?s.textContent=`You paused at panel ${Math.min(t.lastPanelIndex+1,n)}.`:s.textContent="You have not started this adventure yet.",i.classList.toggle("hidden",!e),r.textContent=e?"Restart Story":"Start Story"}function U(t,n){var u,h;const e=(n==null?void 0:n.lastPanelIndex)??0,o=Math.min(e,t.length-1),m=(a=0)=>{const g=`/stories/reader.html?storyId=${l}&panel=${a}`;window.location.href=g};r.addEventListener("click",()=>m(0)),i.addEventListener("click",()=>m(o));const y=((u=t[o])==null?void 0:u.chatTopicId)||((h=t[0])==null?void 0:h.chatTopicId);L.addEventListener("click",()=>{const a=new URL("../chat/index.html",window.location.origin);y&&a.searchParams.set("topicId",y),a.searchParams.set("storyRef",l),window.location.href=`${a.pathname}${a.search}`})}async function R(){if(!l){c.textContent="Story not found",d.textContent="Missing story reference. Please return to the story list.",r.disabled=!0;return}try{const t=await x(l);if(!t)throw new Error("Story not found");c.textContent=t.title,d.textContent=t.summary,B.textContent=t.summary,w.textContent=t.topicTag||"Science",v.textContent=t.readingLevel||"Ages 7-10",S.textContent=t.estimatedTime||"6 min read",E.src=t.coverUrl||"/images/placeholder-story.png",E.alt=t.title;const n=t.panels||[];T(n);const e=C(l);b(e,n.length||6),U(n,e),await P("story_detail_opened",{storyId:l,lastPanelIndex:(e==null?void 0:e.lastPanelIndex)??0})}catch(t){console.error("[story-detail] Unable to load story",t),c.textContent="Story unavailable",d.textContent="We could not load this adventure. Please try again later.",r.disabled=!0,i.disabled=!0}}R();
