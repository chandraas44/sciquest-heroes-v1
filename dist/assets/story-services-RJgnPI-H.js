import{createClient as O}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";import{supabaseConfig as u}from"./config-N_0HKkEA.js";const m={},l=m?.VITE_EDGE_ANALYTICS_URL||"",T=(m?.VITE_USE_STORY_MOCKS??"true")==="true",g="guest-child",_="sqh_story_progress_v1",S="sqh_analytics_queue_v1";let f=null,c=null;function h(){return!!(u?.url&&u?.anonKey)}function s(){return h()?(f||(f=O(u.url,u.anonKey)),f):null}function a(){return T?!0:!h()}async function i(){if(c)return c;const e=await fetch(new URL("/assets/mockStories-eO74wqt_.json",import.meta.url));if(!e.ok)throw new Error("Unable to load mock story data");return c=(await e.json()).stories||[],c}async function D(){if(a())return i();const e=s();if(!e)return i();try{const{data:n,error:t}=await e.from("stories").select(`
        id,
        title,
        cover_url,
        topic_tag,
        reading_level,
        estimated_time,
        summary
      `).order("title");if(t)throw t;return(n||[]).map(r=>({id:r.id,title:r.title,coverUrl:r.cover_url,topicTag:r.topic_tag,readingLevel:r.reading_level,estimatedTime:r.estimated_time,summary:r.summary}))}catch(n){return console.warn("[stories] Supabase stories fetch failed, reverting to mock data",n),i()}}async function U(e){if(!e)throw new Error("storyId is required");if(a())return(await i()).find(r=>r.id===e)||null;const n=s();if(!n)return(await i()).find(r=>r.id===e)||null;try{const{data:t,error:r}=await n.from("stories").select("*").eq("id",e).maybeSingle();if(r||!t)throw r||new Error("missing story");return{id:t.id,title:t.title,coverUrl:t.cover_url,topicTag:t.topic_tag,readingLevel:t.reading_level,estimatedTime:t.estimated_time,summary:t.summary,panels:t.panels}}catch(t){return console.warn("[stories] Supabase story fetch failed, reverting to mock data",t),(await i()).find(o=>o.id===e)||null}}async function N(e){return(await U(e))?.panels||[]}function v(){if(typeof window>"u")return{};try{const e=window.localStorage.getItem(_);return e?JSON.parse(e):{}}catch(e){return console.warn("[stories] Unable to read progress store",e),{}}}function b(e){if(!(typeof window>"u"))try{window.localStorage.setItem(_,JSON.stringify(e))}catch(n){console.warn("[stories] Unable to write progress store",n)}}function R(e,n=g){return v()[n]?.[e]||{lastPanelIndex:0,completedAt:null}}async function P({storyId:e,lastPanelIndex:n=0,completed:t=!1,childId:r=g}){if(!e)throw new Error("storyId is required to save progress");const o=v();o[r]||(o[r]={}),o[r][e]={lastPanelIndex:n,completedAt:t?new Date().toISOString():o[r][e]?.completedAt||null},b(o);const y=s();if(y&&!a())try{await y.from("story_progress").upsert({child_id:r,story_id:e,last_panel_index:n,completed_at:t?new Date().toISOString():null})}catch(A){console.warn("[stories] Supabase progress upsert failed",A)}}function d(){if(typeof window>"u")return[];try{const e=window.localStorage.getItem(S);return e?JSON.parse(e):[]}catch(e){return console.warn("[stories] Failed to read analytics queue",e),[]}}function w(e){if(!(typeof window>"u"))try{window.localStorage.setItem(S,JSON.stringify(e))}catch(n){console.warn("[stories] Failed to update analytics queue",n)}}function k(e){const n=d();n.push(e),w(n)}async function E(e){if(!e)return;const n=d();if(!n.length)return;const{error:t}=await e.from("analytics_events").insert(n.map(r=>({event_type:r.eventType,payload:r.payload,occurred_at:r.timestamp})));if(t){console.warn("[stories] Unable to flush analytics queue",t);return}w([])}async function q(e){if(!l)return!1;try{return(await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok}catch(n){return console.warn("[stories] Edge analytics call failed",n),!1}}async function p(){if(l){const n=d();if(!n.length)return;const t=[];for(const r of n)await q(r)||t.push(r);if(w(t),!t.length)return}const e=s();e&&await E(e)}async function Y(e,n={}){if(!e)return;const t={eventType:e,payload:n,timestamp:new Date().toISOString()};if(l&&await q(t))return;const r=s();if(r&&!a())try{const{error:o}=await r.from("analytics_events").insert({event_type:t.eventType,payload:t.payload,occurred_at:t.timestamp});if(!o){await E(r);return}console.warn("[stories] analytics insert failed, queueing",o)}catch(o){console.warn("[stories] analytics insert crashed, queueing",o)}k(t)}function I(){return a()}typeof window<"u"&&(window.addEventListener("online",()=>{p()}),p());export{p as flushAnalyticsQueue,N as getPanelsForStory,U as getStoryById,D as getStoryList,R as getStoryProgressSummary,I as isUsingStoryMocks,Y as logAnalyticsEvent,P as saveStoryProgress};
