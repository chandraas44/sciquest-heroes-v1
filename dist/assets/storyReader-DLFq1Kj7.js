import"./config-N_0HKkEA.js";import{logAnalyticsEvent as p,isUsingStoryMocks as x,getStoryById as b,getPanelsForStory as v,getStoryProgressSummary as C,saveStoryProgress as L}from"./story-services-RJgnPI-H.js";import{evaluateBadgeRules as T,getBadgeById as _}from"./badge-services-BEYCrsbD.js";import{s as k}from"./badge-celebration-C4tXiTtu.js";import"./logo-handler-BTCRg4Zu.js";import{_ as h}from"./preload-helper-BXl3LOEh.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const E=new URLSearchParams(window.location.search);let a=E.get("storyId");if(!a){const e=window.location.pathname.match(/^\/stories\/([^/]+)\/read$/);e&&(a=e[1])}const c=Number(E.get("panel"))||0,S=document.getElementById("viewerStoryTitle"),$=document.getElementById("panelImage"),M=document.getElementById("panelTag"),s=document.getElementById("panelNarration"),N=document.getElementById("panelPositionLabel"),f=document.getElementById("progressDots"),U=document.getElementById("helperTitle"),D=document.getElementById("helperText"),A=document.getElementById("progressSummary"),w=document.getElementById("chatCtaBtn"),i=document.getElementById("prevPanelBtn"),l=document.getElementById("nextPanelBtn"),R=document.getElementById("openGlossaryBtn"),d=document.getElementById("glossaryDialog"),u=document.getElementById("glossaryList"),O=document.getElementById("closeGlossaryBtn"),I=document.getElementById("viewerOfflineBanner"),t={story:null,panels:[],currentPanelIndex:0,panelCount:0};function m(){if(!I)return;const e=x()||navigator.onLine===!1;I.classList.toggle("hidden",!e)}function H(){f.innerHTML="",t.panels.forEach((e,n)=>{const o=document.createElement("span");o.className="dot"+(n===t.currentPanelIndex?" active":""),o.title=`Panel ${n+1}: ${t.panels[n]?.narration?.substring(0,50)}...`||`Panel ${n+1}`,o.addEventListener("click",()=>{y(n),q()}),f.appendChild(o)})}function q(){s&&(s.classList.add("animate-pulse"),setTimeout(()=>{s.classList.remove("animate-pulse")},600))}function z(e=[]){if(u.innerHTML="",!e.length){u.innerHTML='<p class="text-slate-500 text-sm">No glossary terms on this panel.</p>';return}e.forEach(n=>{const o=document.createElement("span");o.className="glossary-pill px-3 py-1 rounded-full bg-indigo-100 border border-indigo-200 text-indigo-700 font-semibold",o.textContent=n,u.appendChild(o)})}function P(){const e=t.panels[t.currentPanelIndex];e&&($.src=e.imageUrl||"/images/placeholder-story.png",M.textContent=e.panelId||`Panel ${t.currentPanelIndex+1}`,s.textContent=e.narration,N.textContent=`Panel ${t.currentPanelIndex+1} of ${t.panelCount}`,U.textContent=e.ctaLabel||"Ask a question",D.textContent="Use the chat companion to dig deeper into this scene.",A.textContent=`Panel ${t.currentPanelIndex+1}/${t.panelCount}`,w.textContent=e.ctaLabel||"Ask the AI about this panel",w.onclick=()=>{const n=new URL("../chat/index.html",window.location.origin);e.chatTopicId&&n.searchParams.set("topicId",e.chatTopicId),n.searchParams.set("storyRef",a),n.searchParams.set("panelId",e.panelId??`panel-${t.currentPanelIndex+1}`),window.location.href=`${n.pathname}${n.search}`},i.disabled=t.currentPanelIndex===0,l.disabled=t.currentPanelIndex===t.panelCount-1,H(),z(e.glossaryTerms||[]))}async function g(e=!1){await L({storyId:a,lastPanelIndex:t.currentPanelIndex,completed:e})}async function y(e){if(!(e<0||e>=t.panelCount)){if(t.currentPanelIndex=e,P(),a){const n=`/stories/${a}/read?panel=${e}`;window.history.replaceState({storyId:a,panel:e},"",n)}await g(e===t.panelCount-1),await p("panel_viewed",{storyId:a,panelId:t.panels[e]?.panelId,panelIndex:e})}}async function F(){if(t.currentPanelIndex>=t.panelCount-1){await g(!0),await p("story_completed",{storyId:a});const e="child-akhil";try{const n=await T(e,"story_completed",{storyId:a,topicTag:t.story?.topicTag||null,sourceFeature:"story_viewer"});for(const o of n){const r=await _(o.badgeId);r&&k(o.badgeId,r.name,r.icon)}}catch(n){console.warn("[story-viewer] Badge evaluation failed",n)}l.disabled=!0;return}await y(t.currentPanelIndex+1)}async function G(){t.currentPanelIndex!==0&&await y(t.currentPanelIndex-1)}async function K(){if(!a)throw new Error("storyId missing");const[e,n]=await Promise.all([b(a),v(a)]);if(!e)throw new Error("story not found");if(t.story=e,t.panels=n.length?n:e.panels||[],t.panelCount=t.panels.length,!t.panelCount)throw new Error("story has no panels");S.textContent=e.title;const o=C(a),r=Number.isFinite(c)&&c>=0?c:o?.lastPanelIndex||0;t.currentPanelIndex=Math.min(r,t.panelCount-1)}function Q(){l.addEventListener("click",F),i.addEventListener("click",G),R.addEventListener("click",()=>{d&&d.showModal()}),O.addEventListener("click",()=>d?.close());const e=document.getElementById("takeQuizBtn");e&&e.addEventListener("click",()=>{a&&(window.location.href=`/stories/${a}/quiz`)})}async function V(){try{if(m(),window.addEventListener("online",m),window.addEventListener("offline",m),!a){const e=window.location.pathname.match(/^\/stories\/([^/]+)\/read$/);if(e)a=e[1];else throw new Error("Story ID not found. Please navigate from the story list.")}if(await K(),Q(),P(),a&&window.location.pathname!==`/stories/${a}/read`){const e=`/stories/${a}/read?panel=${t.currentPanelIndex}`;window.history.replaceState({storyId:a,panel:t.currentPanelIndex},"",e)}await g(),await p("story_viewer_opened",{storyId:a,panelIndex:t.currentPanelIndex})}catch(e){console.error("[story-viewer] Failed to initialize viewer",e),s&&(s.textContent="Unable to load this story. Please head back to the story list."),l&&(l.disabled=!0),i&&(i.disabled=!0);const n=document.createElement("div");n.className="max-w-5xl mx-auto px-6 mt-6 bg-red-50 border border-red-200 rounded-2xl p-4 text-red-800",n.innerHTML=`
      <p class="font-semibold mb-2">⚠️ Error loading story</p>
      <p class="text-sm">${e.message||"Please check the story URL and try again."}</p>
      <a href="./index.html" class="text-sm underline mt-2 inline-block">← Back to Stories</a>
    `,document.querySelector("main")?.insertBefore(n,document.querySelector("main")?.firstChild)}}V();const B=async()=>{try{const{createClient:e}=await h(async()=>{const{createClient:o}=await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm");return{createClient:o}},[]),{supabaseConfig:n}=await h(async()=>{const{supabaseConfig:o}=await import("./config-N_0HKkEA.js");return{supabaseConfig:o}},[]);if(n?.url&&n?.anonKey){const o=e(n.url,n.anonKey),{error:r}=await o.auth.signOut();if(r)throw r}}catch{console.log("Supabase logout skipped (mock mode)")}localStorage.clear(),sessionStorage.clear(),window.location.href="../auth/auth.html"};document.getElementById("logoutBtn")?.addEventListener("click",B);document.getElementById("logoutBtnMobile")?.addEventListener("click",B);
