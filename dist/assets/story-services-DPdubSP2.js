import{createClient as T}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";import{s as d}from"./config-ClyacVFi.js";const s={},l=(s==null?void 0:s.VITE_EDGE_ANALYTICS_URL)||"",U=((s==null?void 0:s.VITE_USE_STORY_MOCKS)??"true")==="true",S="guest-child",h="sqh_story_progress_v1",_="sqh_analytics_queue_v1";let f=null,u=null;function E(){var e;return!!((e=d)!=null&&e.url)}function a(){return E()?(f||(f=T(d.url,d.anonKey)),f):null}function c(){return U?!0:!E()}async function i(){if(u)return u;const e=await fetch(new URL("/assets/mockStories-eO74wqt_.json",import.meta.url));if(!e.ok)throw new Error("Unable to load mock story data");return u=(await e.json()).stories||[],u}async function N(){if(c())return i();const e=a();if(!e)return i();try{const{data:r,error:n}=await e.from("stories").select(`
        id,
        title,
        cover_url,
        topic_tag,
        reading_level,
        estimated_time,
        summary
      `).order("title");if(n)throw n;return(r||[]).map(t=>({id:t.id,title:t.title,coverUrl:t.cover_url,topicTag:t.topic_tag,readingLevel:t.reading_level,estimatedTime:t.estimated_time,summary:t.summary}))}catch(r){return console.warn("[stories] Supabase stories fetch failed, reverting to mock data",r),i()}}async function b(e){if(!e)throw new Error("storyId is required");if(c())return(await i()).find(t=>t.id===e)||null;const r=a();if(!r)return(await i()).find(t=>t.id===e)||null;try{const{data:n,error:t}=await r.from("stories").select("*").eq("id",e).maybeSingle();if(t||!n)throw t||new Error("missing story");return{id:n.id,title:n.title,coverUrl:n.cover_url,topicTag:n.topic_tag,readingLevel:n.reading_level,estimatedTime:n.estimated_time,summary:n.summary,panels:n.panels}}catch(n){return console.warn("[stories] Supabase story fetch failed, reverting to mock data",n),(await i()).find(o=>o.id===e)||null}}async function R(e){const r=await b(e);return(r==null?void 0:r.panels)||[]}function v(){if(typeof window>"u")return{};try{const e=window.localStorage.getItem(h);return e?JSON.parse(e):{}}catch(e){return console.warn("[stories] Unable to read progress store",e),{}}}function k(e){if(!(typeof window>"u"))try{window.localStorage.setItem(h,JSON.stringify(e))}catch(r){console.warn("[stories] Unable to write progress store",r)}}function P(e,r=S){var t;return((t=v()[r])==null?void 0:t[e])||{lastPanelIndex:0,completedAt:null}}async function Y({storyId:e,lastPanelIndex:r=0,completed:n=!1,childId:t=S}){var g;if(!e)throw new Error("storyId is required to save progress");const o=v();o[t]||(o[t]={}),o[t][e]={lastPanelIndex:r,completedAt:n?new Date().toISOString():((g=o[t][e])==null?void 0:g.completedAt)||null},k(o);const p=a();if(p&&!c())try{await p.from("story_progress").upsert({child_id:t,story_id:e,last_panel_index:r,completed_at:n?new Date().toISOString():null})}catch(O){console.warn("[stories] Supabase progress upsert failed",O)}}function w(){if(typeof window>"u")return[];try{const e=window.localStorage.getItem(_);return e?JSON.parse(e):[]}catch(e){return console.warn("[stories] Failed to read analytics queue",e),[]}}function y(e){if(!(typeof window>"u"))try{window.localStorage.setItem(_,JSON.stringify(e))}catch(r){console.warn("[stories] Failed to update analytics queue",r)}}function C(e){const r=w();r.push(e),y(r)}async function q(e){if(!e)return;const r=w();if(!r.length)return;const{error:n}=await e.from("analytics_events").insert(r.map(t=>({event_type:t.eventType,payload:t.payload,occurred_at:t.timestamp})));if(n){console.warn("[stories] Unable to flush analytics queue",n);return}y([])}async function A(e){if(!l)return!1;try{return(await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok}catch(r){return console.warn("[stories] Edge analytics call failed",r),!1}}async function m(){if(l){const r=w();if(!r.length)return;const n=[];for(const t of r)await A(t)||n.push(t);if(y(n),!n.length)return}const e=a();e&&await q(e)}async function I(e,r={}){if(!e)return;const n={eventType:e,payload:r,timestamp:new Date().toISOString()};if(l&&await A(n))return;const t=a();if(t&&!c())try{const{error:o}=await t.from("analytics_events").insert({event_type:n.eventType,payload:n.payload,occurred_at:n.timestamp});if(!o){await q(t);return}console.warn("[stories] analytics insert failed, queueing",o)}catch(o){console.warn("[stories] analytics insert crashed, queueing",o)}C(n)}function M(){return c()}typeof window<"u"&&(window.addEventListener("online",()=>{m()}),m());export{m as flushAnalyticsQueue,R as getPanelsForStory,b as getStoryById,N as getStoryList,P as getStoryProgressSummary,M as isUsingStoryMocks,I as logAnalyticsEvent,Y as saveStoryProgress};
