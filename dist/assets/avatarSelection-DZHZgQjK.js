import{supabaseConfig as f}from"./config-N_0HKkEA.js";import{createClient as v}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const h=f.url,p=f.anonKey,r=v(h,p),s=document.getElementById("avatarGrid"),o=document.getElementById("confirmBtn"),u=document.getElementById("confirmBtnText"),w=document.getElementById("skipBtn"),c=document.getElementById("errorMessage");let l=null,i=[];function d(e){c.textContent=e,c.classList.add("show"),window.scrollTo({top:0,behavior:"smooth"})}function y(){c.classList.remove("show")}async function b(){try{const{data:e,error:a}=await r.storage.from("avatars").list("",{limit:100,offset:0,sortBy:{column:"name",order:"asc"}});if(console.log("Supabase Storage List Response:",{data:e,error:a}),a)throw a;return!e||e.length===0?(console.warn('No avatars found in storage bucket "avatars".'),[]):e.filter(n=>n.name.match(/\.(png|jpg|jpeg|gif|webp)$/i)).map(n=>{const{data:g}=r.storage.from("avatars").getPublicUrl(n.name),m=n.name.split(".")[0];return{id:m.toLowerCase(),name:m,image:g.publicUrl}})}catch(e){return console.error("Error fetching avatars:",e),d("Failed to load avatars. Please refresh the page."),[]}}async function E(){if(s.innerHTML='<div class="loading-spinner" style="margin: 20px auto;"></div>',i=await b(),s.innerHTML="",i.length===0){s.innerHTML='<p style="color: white; text-align: center; grid-column: 1/-1;">No avatars available.</p>';return}i.forEach(e=>{const a=document.createElement("div");a.className="avatar-card",a.dataset.avatarId=e.id,a.innerHTML=`
            <div class="avatar-image-wrapper">
                <img src="${e.image}" alt="${e.name}" onerror="this.src='assets/avatars/Bolt.png'">
            </div>
            <div class="avatar-name">${e.name}</div>
        `,a.addEventListener("click",()=>L(e.id)),s.appendChild(a)})}function L(e){y(),document.querySelectorAll(".avatar-card").forEach(t=>{t.classList.remove("selected")});const a=document.querySelector(`[data-avatar-id="${e}"]`);a&&(a.classList.add("selected"),l=i.find(t=>t.id===e),o.disabled=!1)}async function B(e){try{const{data:{session:a}}=await r.auth.getSession();if(!a)throw new Error("No active session. Please log in again.");const{error:t}=await r.from("user_profiles").update({avatar_url:e}).eq("id",a.user.id);if(t)throw t;return!0}catch(a){throw console.error("Error saving avatar:",a),a}}o.addEventListener("click",async()=>{if(!l){d("Please select an avatar");return}o.disabled=!0,u.innerHTML='<span class="loading-spinner"></span>Saving...';try{await B(l.image),localStorage.removeItem("newStudentSignup"),setTimeout(()=>{window.location.href="stories/index.html"},500)}catch{d("Failed to save avatar. Please try again."),o.disabled=!1,u.textContent="Confirm Selection"}});w.addEventListener("click",()=>{window.location.href="stories/index.html"});async function S(){const{data:{session:e}}=await r.auth.getSession();if(!e){window.location.href="auth/auth.html";return}const{data:a}=await r.from("user_profiles").select("account_type").eq("id",e.user.id).maybeSingle();if(a&&a.account_type!=="student"){window.location.href="index.html";return}}(async()=>(await S(),await E()))();
