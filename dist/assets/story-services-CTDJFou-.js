import{createClient as T}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";import{supabaseConfig as l}from"./config-CMljicwL.js";const s={},f=(s==null?void 0:s.VITE_EDGE_ANALYTICS_URL)||"",U=((s==null?void 0:s.VITE_USE_STORY_MOCKS)??"true")==="true",S="guest-child",h="sqh_story_progress_v1",_="sqh_analytics_queue_v1";let d=null,u=null;function E(){var e,t;return!!((e=l)!=null&&e.url&&((t=l)!=null&&t.anonKey))}function a(){return E()?(d||(d=T(l.url,l.anonKey)),d):null}function c(){return U?!0:!E()}async function i(){if(u)return u;const e=await fetch(new URL("/assets/mockStories-eO74wqt_.json",import.meta.url));if(!e.ok)throw new Error("Unable to load mock story data");return u=(await e.json()).stories||[],u}async function N(){if(c())return i();const e=a();if(!e)return i();try{const{data:t,error:n}=await e.from("stories").select(`
        id,
        title,
        cover_url,
        topic_tag,
        reading_level,
        estimated_time,
        summary
      `).order("title");if(n)throw n;return(t||[]).map(r=>({id:r.id,title:r.title,coverUrl:r.cover_url,topicTag:r.topic_tag,readingLevel:r.reading_level,estimatedTime:r.estimated_time,summary:r.summary}))}catch(t){return console.warn("[stories] Supabase stories fetch failed, reverting to mock data",t),i()}}async function b(e){if(!e)throw new Error("storyId is required");if(c())return(await i()).find(r=>r.id===e)||null;const t=a();if(!t)return(await i()).find(r=>r.id===e)||null;try{const{data:n,error:r}=await t.from("stories").select("*").eq("id",e).maybeSingle();if(r||!n)throw r||new Error("missing story");return{id:n.id,title:n.title,coverUrl:n.cover_url,topicTag:n.topic_tag,readingLevel:n.reading_level,estimatedTime:n.estimated_time,summary:n.summary,panels:n.panels}}catch(n){return console.warn("[stories] Supabase story fetch failed, reverting to mock data",n),(await i()).find(o=>o.id===e)||null}}async function R(e){const t=await b(e);return(t==null?void 0:t.panels)||[]}function v(){if(typeof window>"u")return{};try{const e=window.localStorage.getItem(h);return e?JSON.parse(e):{}}catch(e){return console.warn("[stories] Unable to read progress store",e),{}}}function k(e){if(!(typeof window>"u"))try{window.localStorage.setItem(h,JSON.stringify(e))}catch(t){console.warn("[stories] Unable to write progress store",t)}}function P(e,t=S){var r;return((r=v()[t])==null?void 0:r[e])||{lastPanelIndex:0,completedAt:null}}async function Y({storyId:e,lastPanelIndex:t=0,completed:n=!1,childId:r=S}){var g;if(!e)throw new Error("storyId is required to save progress");const o=v();o[r]||(o[r]={}),o[r][e]={lastPanelIndex:t,completedAt:n?new Date().toISOString():((g=o[r][e])==null?void 0:g.completedAt)||null},k(o);const p=a();if(p&&!c())try{await p.from("story_progress").upsert({child_id:r,story_id:e,last_panel_index:t,completed_at:n?new Date().toISOString():null})}catch(O){console.warn("[stories] Supabase progress upsert failed",O)}}function w(){if(typeof window>"u")return[];try{const e=window.localStorage.getItem(_);return e?JSON.parse(e):[]}catch(e){return console.warn("[stories] Failed to read analytics queue",e),[]}}function y(e){if(!(typeof window>"u"))try{window.localStorage.setItem(_,JSON.stringify(e))}catch(t){console.warn("[stories] Failed to update analytics queue",t)}}function C(e){const t=w();t.push(e),y(t)}async function q(e){if(!e)return;const t=w();if(!t.length)return;const{error:n}=await e.from("analytics_events").insert(t.map(r=>({event_type:r.eventType,payload:r.payload,occurred_at:r.timestamp})));if(n){console.warn("[stories] Unable to flush analytics queue",n);return}y([])}async function A(e){if(!f)return!1;try{return(await fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok}catch(t){return console.warn("[stories] Edge analytics call failed",t),!1}}async function m(){if(f){const t=w();if(!t.length)return;const n=[];for(const r of t)await A(r)||n.push(r);if(y(n),!n.length)return}const e=a();e&&await q(e)}async function I(e,t={}){if(!e)return;const n={eventType:e,payload:t,timestamp:new Date().toISOString()};if(f&&await A(n))return;const r=a();if(r&&!c())try{const{error:o}=await r.from("analytics_events").insert({event_type:n.eventType,payload:n.payload,occurred_at:n.timestamp});if(!o){await q(r);return}console.warn("[stories] analytics insert failed, queueing",o)}catch(o){console.warn("[stories] analytics insert crashed, queueing",o)}C(n)}function K(){return c()}typeof window<"u"&&(window.addEventListener("online",()=>{m()}),m());export{m as flushAnalyticsQueue,R as getPanelsForStory,b as getStoryById,N as getStoryList,P as getStoryProgressSummary,K as isUsingStoryMocks,I as logAnalyticsEvent,Y as saveStoryProgress};
