import{supabaseConfig as R}from"./config-N_0HKkEA.js";import{createClient as D}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const U=R.url,A=R.anonKey;(!U||!A)&&console.error("Missing Supabase configuration");const d=D(U,A);let u=!1,t="";const M=new URLSearchParams(window.location.search),N=M.get("mode"),L=M.get("type");N==="signup"&&(u=!0),t=L||localStorage.getItem("accountType")||"";const I=document.getElementById("authTitle"),T=document.getElementById("authSubtitle"),m=document.getElementById("submitBtnText"),S=document.getElementById("googleBtnText"),x=document.getElementById("toggleText"),w=document.getElementById("toggleModeLink"),P=document.getElementById("forgotPasswordContainer"),G=document.getElementById("authForm"),y=document.getElementById("googleSignInBtn"),v=document.getElementById("divider"),f=document.getElementById("errorMessage"),h=document.getElementById("successMessage"),q=document.getElementById("modeToggleTop"),B=document.getElementById("modeToggleTopText"),C=document.getElementById("modeToggleIcon");function b(){const o=t==="student";y&&(y.style.display=o?"none":"flex"),v&&(v.style.display=o?"none":"flex"),u?(I.textContent="Create a free account",T.textContent=`Join SciQuest Heroes as a ${t||"member"}`,m.textContent="Sign Up",S.textContent="Sign up with Google",x.textContent="Already have an account?",w.textContent="Log In",B.textContent="Log In",C.className="fas fa-sign-in-alt",P.style.display="none"):(I.textContent="Welcome Back!",T.textContent="Sign in to continue your adventure",m.textContent="Log In",S.textContent="Continue with Google",x.textContent="Don't have an account?",w.textContent="Sign Up",B.textContent="Sign Up",C.className="fas fa-user-plus",P.style.display="block")}b();function F(o){o.preventDefault(),u=!u,b(),p()}w.addEventListener("click",F);q.addEventListener("click",F);function l(o){f.textContent=o,f.classList.add("show"),h.classList.remove("show")}function c(o){h.textContent=o,h.classList.add("show"),f.classList.remove("show")}function p(){f.classList.remove("show"),h.classList.remove("show")}function k(o){const r=document.getElementById("submitBtn"),s=document.getElementById("googleSignInBtn");o?(r.disabled=!0,s.disabled=!0,m.innerHTML='<span class="loading-spinner"></span>Processing...'):(r.disabled=!1,s.disabled=!1,m.textContent=u?"Sign Up":"Log In")}async function _(o,r,s){try{const{data:e}=await d.from("user_profiles").select("*").eq("id",o).maybeSingle();if(e){console.log("User profile already exists");return}const{error:n}=await d.from("user_profiles").insert({id:o,email:r,account_type:s||"student"});if(n){if(n.code==="23505"){console.log("User profile already exists (duplicate key)");return}throw console.error("Error creating user profile:",n),n}}catch(e){throw console.error("Failed to create user profile:",e),e}}G.addEventListener("submit",async o=>{o.preventDefault(),p();const r=document.getElementById("email").value.trim(),s=document.getElementById("password").value;if(!r||!s){l("Please fill in all fields");return}if(s.length<6){l("Password must be at least 6 characters long");return}k(!0);try{if(u){const{data:e,error:n}=await d.auth.signUp({email:r,password:s});if(n)throw n;if(e.user){await _(e.user.id,r,t),c("Account created successfully! Redirecting...");const i=t||"student";localStorage.removeItem("accountType"),setTimeout(()=>{i==="parent"?window.location.href="../parent/dashboard.html":i==="teacher"?window.location.href="../dashboards/teacher-dashboard.html":i==="student"?window.location.href="../stories/index.html":window.location.href="../index.html"},1500)}}else{console.log("=== Login Attempt ==="),console.log("Email:",r),console.log("Account type from context:",t||"not specified");const{data:e,error:n}=await d.auth.signInWithPassword({email:r,password:s});if(n)throw console.error("=== Authentication Error ==="),console.error("Error:",n),console.error("Error message:",n.message),n;if(e.user){console.log("=== Authentication Successful ==="),console.log("User ID:",e.user.id),console.log("User email:",e.user.email),console.log("Fetching user profile...");const{data:i,error:a}=await d.from("user_profiles").select("account_type").eq("id",e.user.id).maybeSingle();if(a){if(console.error("=== Profile Fetch Error ==="),console.error("Error object:",a),console.error("Error details:",{code:a.code,message:a.message,details:a.details,hint:a.hint,userId:e.user.id,userEmail:e.user.email,accountTypeFromContext:t,timestamp:new Date().toISOString()}),a.code==="42501"||a.message?.toLowerCase().includes("permission denied")||a.message?.toLowerCase().includes("policy")||a.message?.toLowerCase().includes("row-level security")){console.error("=== RLS Policy Error Detected ==="),console.error("This indicates a Row Level Security (RLS) policy configuration issue."),console.error("The user is authenticated but cannot read their own profile from user_profiles table."),console.error("Possible causes:"),console.error('  1. Missing "Users can read own profile" policy'),console.error("  2. Conflicting RLS policies"),console.error("  3. Recursive RLS checks in parent-child policies"),console.error("Solution: Run fix_rls_login_error.sql in Supabase SQL Editor");const E="RLS-"+Date.now();console.error("Error code for support:",E),l(`Account access error. Please contact support with error code: ${E}. This is a database configuration issue that needs to be fixed by an administrator.`)}else console.warn("Non-RLS profile fetch error, attempting fallback based on account type context"),t==="student"?(console.warn("Profile fetch error, redirecting to student dashboard (fallback)"),c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../stories/index.html"},1500)):t==="parent"?(console.warn("Profile fetch error, redirecting to parent dashboard (fallback)"),c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../parent/dashboard.html"},1500)):t==="teacher"?(console.warn("Profile fetch error, redirecting to teacher dashboard (fallback)"),c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/teacher-dashboard.html"},1500)):(console.warn("Profile fetch error, showing error message (no fallback available)"),l("Unable to load your account profile. Please try again or contact support."));return}if(!i){console.warn("User profile not found in database, attempting fallback based on account type context"),console.warn("Profile lookup details:",{userId:e.user.id,userEmail:e.user.email,accountTypeFromContext:t}),t==="student"?(console.warn("User profile not found, redirecting to student dashboard (fallback)"),c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../stories/index.html"},1500)):t==="parent"?(console.warn("User profile not found, redirecting to parent dashboard (fallback)"),c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../parent/dashboard.html"},1500)):t==="teacher"?(console.warn("User profile not found, redirecting to teacher dashboard (fallback)"),c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/teacher-dashboard.html"},1500)):(console.warn("User profile not found, showing error message (no fallback available)"),l("User profile not found. Please contact support to set up your account."));return}if(!i.account_type){console.warn("Account type missing in profile, attempting fallback based on account type context"),console.warn("Profile data:",{userId:e.user.id,userEmail:e.user.email,profileData:i,accountTypeFromContext:t}),t==="student"?(console.warn("Account type missing in profile, redirecting to student dashboard (fallback)"),c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../stories/index.html"},1500)):t==="parent"?(console.warn("Account type missing in profile, redirecting to parent dashboard (fallback)"),c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../parent/dashboard.html"},1500)):t==="teacher"?(console.warn("Account type missing in profile, redirecting to teacher dashboard (fallback)"),c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/teacher-dashboard.html"},1500)):(console.warn("Account type missing in profile, showing error message (no fallback available)"),l("Account type is missing from your profile. Please contact support."));return}const g=i.account_type.toLowerCase().trim();if(console.log("=== Profile Retrieved Successfully ==="),console.log("User account type from profile:",g),console.log("Account type from context:",t),g==="parent"){c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../parent/dashboard.html"},1500);return}else if(g==="teacher"){c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/teacher-dashboard.html"},1500);return}else if(g==="student"){c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../stories/index.html"},1500);return}else t==="student"?(console.warn("Invalid account_type:",g,"redirecting to student dashboard"),c("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../stories/index.html"},1500)):(console.warn("Invalid account_type:",g,"showing error message"),l("Invalid account type detected. Please contact support."))}}}catch(e){console.error("=== Authentication Flow Error ==="),console.error("Error object:",e),console.error("Error message:",e.message),console.error("Error code:",e.code),console.error("Error details:",e.details),console.error("Error hint:",e.hint),console.error("Mode:",u?"Sign Up":"Login"),console.error("Account type context:",t||"not specified"),console.error("Timestamp:",new Date().toISOString()),e.message?.includes("Invalid login credentials")?(console.warn("Invalid credentials provided"),l("Invalid email or password. Please try again.")):e.message?.includes("User already registered")?(console.warn("User attempted to sign up with existing email"),l("This email is already registered. Please log in instead."),setTimeout(()=>{u=!1,b(),p()},2e3)):e.message?.includes("Email not confirmed")?(console.warn("User email not confirmed"),l("Please check your email to confirm your account.")):e.message?.includes("duplicate key")?(console.warn("Duplicate key error - user profile may already exist"),l("This account already exists. Please log in instead.")):(console.error("Unhandled authentication error"),l(e.message||"An error occurred. Please try again."))}finally{k(!1)}});y.addEventListener("click",async()=>{if(p(),t==="student"){l("Google sign-in is not available for student accounts. Please use email and password.");return}try{const{data:o,error:r}=await d.auth.signInWithOAuth({provider:"google",options:{redirectTo:window.location.origin+"/auth/callback.html",queryParams:{prompt:"select_account"}}});if(r)throw r}catch(o){console.error("Google sign-in error:",o),l("Failed to sign in with Google. Please try again.")}});document.getElementById("forgotPasswordLink").addEventListener("click",o=>{o.preventDefault(),H()});function H(){const o=document.getElementById("forgotPasswordModal");o.style.display="flex",document.getElementById("resetEmail").value=document.getElementById("email").value}window.closeForgotPasswordModal=function(){const o=document.getElementById("forgotPasswordModal");o.style.display="none",document.getElementById("resetErrorMessage").classList.remove("show"),document.getElementById("resetSuccessMessage").classList.remove("show")};document.getElementById("resetPasswordForm").addEventListener("submit",async o=>{o.preventDefault();const r=document.getElementById("resetEmail").value.trim(),s=document.getElementById("resetErrorMessage"),e=document.getElementById("resetSuccessMessage"),n=document.getElementById("resetSubmitBtn"),i=document.getElementById("resetBtnText");if(!r){s.textContent="Please enter your email address",s.classList.add("show");return}n.disabled=!0,i.innerHTML='<span class="loading-spinner"></span>Sending...';try{const{error:a}=await d.auth.resetPasswordForEmail(r,{redirectTo:window.location.origin+"/auth/auth.html"});if(a)throw a;e.textContent="Password reset email sent! Check your inbox.",e.classList.add("show"),s.classList.remove("show"),setTimeout(()=>{closeForgotPasswordModal()},3e3)}catch(a){console.error("Password reset error:",a),s.textContent=a.message||"Failed to send reset email. Please try again.",s.classList.add("show"),e.classList.remove("show")}finally{n.disabled=!1,i.textContent="Send Reset Link"}});d.auth.onAuthStateChange((o,r)=>{(async()=>{if(o==="SIGNED_IN"&&r){console.log("=== Auth State Change: SIGNED_IN ==="),console.log("User ID:",r.user.id),console.log("User email:",r.user.email);const{data:s,error:e}=await d.from("user_profiles").select("*").eq("id",r.user.id).maybeSingle();if(e&&(console.error("=== Profile Fetch Error in Auth State Change ==="),console.error("Error:",e),console.error("Error code:",e.code),console.error("Error message:",e.message),(e.code==="42501"||e.message?.toLowerCase().includes("permission denied")||e.message?.toLowerCase().includes("policy")||e.message?.toLowerCase().includes("row-level security"))&&(console.error("RLS policy error detected in auth state change handler"),console.error("This may prevent profile creation. Check RLS policies."))),s)console.log("Profile found during auth state change:",{accountType:s.account_type,email:s.email});else{console.warn("Profile not found during auth state change, attempting to create");const n=t||localStorage.getItem("accountType")||"student";console.log("Creating profile with account type:",n);try{await _(r.user.id,r.user.email,n),console.log("Profile created successfully during auth state change")}catch(i){console.error("=== Error creating profile during auth state change ==="),console.error("Error:",i),console.error("Error code:",i.code),console.error("Error message:",i.message),console.error("This may indicate an RLS policy issue for INSERT operations")}}}})()});
