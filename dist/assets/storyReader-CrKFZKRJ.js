import"./config-CMljicwL.js";import{logAnalyticsEvent as u,isUsingStoryMocks as L,getStoryById as v,getPanelsForStory as b,getStoryProgressSummary as T,saveStoryProgress as _}from"./story-services-CTDJFou-.js";import{_ as h}from"./preload-helper-D7HrI6pR.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const P=new URLSearchParams(window.location.search);let a=P.get("storyId");if(!a){const e=window.location.pathname.match(/^\/stories\/([^/]+)\/read$/);e&&(a=e[1])}const i=Number(P.get("panel"))||0,S=document.getElementById("viewerStoryTitle"),k=document.getElementById("panelImage"),$=document.getElementById("panelTag"),x=document.getElementById("panelNarration"),U=document.getElementById("panelPositionLabel"),g=document.getElementById("progressDots"),N=document.getElementById("helperTitle"),M=document.getElementById("helperText"),A=document.getElementById("progressSummary"),w=document.getElementById("chatCtaBtn"),p=document.getElementById("prevPanelBtn"),s=document.getElementById("nextPanelBtn"),D=document.getElementById("openGlossaryBtn"),r=document.getElementById("glossaryDialog"),c=document.getElementById("glossaryList"),O=document.getElementById("closeGlossaryBtn"),I=document.getElementById("viewerOfflineBanner"),t={story:null,panels:[],currentPanelIndex:0,panelCount:0};function d(){if(!I)return;const e=L()||navigator.onLine===!1;I.classList.toggle("hidden",!e)}function R(){g.innerHTML="",t.panels.forEach((e,n)=>{const o=document.createElement("span");o.className="dot"+(n===t.currentPanelIndex?" active":""),o.addEventListener("click",()=>y(n)),g.appendChild(o)})}function F(e=[]){if(c.innerHTML="",!e.length){c.innerHTML='<p class="text-white/60 text-sm">No glossary terms on this panel.</p>';return}e.forEach(n=>{const o=document.createElement("span");o.className="glossary-pill px-3 py-1 rounded-full bg-indigo-600/30 border border-white/20 text-white font-semibold",o.textContent=n,c.appendChild(o)})}function B(){const e=t.panels[t.currentPanelIndex];e&&(k.src=e.imageUrl||"/images/placeholder-story.png",$.textContent=e.panelId||`Panel ${t.currentPanelIndex+1}`,x.textContent=e.narration,U.textContent=`Panel ${t.currentPanelIndex+1} of ${t.panelCount}`,N.textContent=e.ctaLabel||"Ask a question",M.textContent="Use the chat companion to dig deeper into this scene.",A.textContent=`Panel ${t.currentPanelIndex+1}/${t.panelCount}`,w.textContent=e.ctaLabel||"Ask the AI about this panel",w.onclick=()=>{const n=new URL("../chat/index.html",window.location.origin);e.chatTopicId&&n.searchParams.set("topicId",e.chatTopicId),n.searchParams.set("storyRef",a),n.searchParams.set("panelId",e.panelId??`panel-${t.currentPanelIndex+1}`),window.location.href=`${n.pathname}${n.search}`},p.disabled=t.currentPanelIndex===0,s.disabled=t.currentPanelIndex===t.panelCount-1,R(),F(e.glossaryTerms||[]))}async function m(e=!1){await _({storyId:a,lastPanelIndex:t.currentPanelIndex,completed:e})}async function y(e){var n;if(!(e<0||e>=t.panelCount)){if(t.currentPanelIndex=e,B(),a){const o=`/stories/${a}/read?panel=${e}`;window.history.replaceState({storyId:a,panel:e},"",o)}await m(e===t.panelCount-1),await u("panel_viewed",{storyId:a,panelId:(n=t.panels[e])==null?void 0:n.panelId,panelIndex:e})}}async function G(){if(t.currentPanelIndex>=t.panelCount-1){await m(!0),await u("story_completed",{storyId:a}),s.disabled=!0;return}await y(t.currentPanelIndex+1)}async function H(){t.currentPanelIndex!==0&&await y(t.currentPanelIndex-1)}async function K(){if(!a)throw new Error("storyId missing");const[e,n]=await Promise.all([v(a),b(a)]);if(!e)throw new Error("story not found");if(t.story=e,t.panels=n.length?n:e.panels||[],t.panelCount=t.panels.length,!t.panelCount)throw new Error("story has no panels");S.textContent=e.title;const o=T(a),l=Number.isFinite(i)&&i>=0?i:(o==null?void 0:o.lastPanelIndex)||0;t.currentPanelIndex=Math.min(l,t.panelCount-1)}function V(){s.addEventListener("click",G),p.addEventListener("click",H),D.addEventListener("click",()=>{r&&r.showModal()}),O.addEventListener("click",()=>r==null?void 0:r.close())}async function j(){try{if(d(),window.addEventListener("online",d),window.addEventListener("offline",d),await K(),V(),B(),a&&window.location.pathname!==`/stories/${a}/read`){const e=`/stories/${a}/read?panel=${t.currentPanelIndex}`;window.history.replaceState({storyId:a,panel:t.currentPanelIndex},"",e)}await m(),await u("story_viewer_opened",{storyId:a,panelIndex:t.currentPanelIndex})}catch(e){console.error("[story-viewer] Failed to initialize viewer",e),x.textContent="Unable to load this story. Please head back to the story list.",s.disabled=!0,p.disabled=!0}}j();const C=async()=>{try{const{createClient:e}=await h(async()=>{const{createClient:o}=await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm");return{createClient:o}},[]),{supabaseConfig:n}=await h(async()=>{const{supabaseConfig:o}=await import("./config-CMljicwL.js");return{supabaseConfig:o}},[]);if(n!=null&&n.url&&(n!=null&&n.anonKey)){const o=e(n.url,n.anonKey),{error:l}=await o.auth.signOut();if(l)throw l}}catch{console.log("Supabase logout skipped (mock mode)")}localStorage.clear(),sessionStorage.clear(),window.location.href="../auth/auth.html"};var E;(E=document.getElementById("logoutBtn"))==null||E.addEventListener("click",C);var f;(f=document.getElementById("logoutBtnMobile"))==null||f.addEventListener("click",C);
