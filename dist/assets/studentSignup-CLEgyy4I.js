import{s as T}from"./config-4EZbmldV.js";import{createClient as _}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const k=T.url,A=T.anonKey,l=_(k,A);let r={age:"",parentEmail:"",firstName:"",email:"",password:""};const I=document.getElementById("panel1"),B=document.getElementById("panel2"),R=document.getElementById("panel1Form"),M=document.getElementById("panel2Form"),U=document.getElementById("backBtn"),c=document.getElementById("errorMessage"),d=document.getElementById("successMessage"),L=document.getElementById("panelTitle"),b=document.getElementById("panelSubtitle"),i=document.getElementById("step1Indicator"),P=document.getElementById("step2Indicator"),S=document.getElementById("progressLine");function t(a){c.textContent=a,c.classList.add("show"),d.classList.remove("show"),window.scrollTo({top:0,behavior:"smooth"})}function D(a){d.textContent=a,d.classList.add("show"),c.classList.remove("show"),window.scrollTo({top:0,behavior:"smooth"})}function y(){c.classList.remove("show"),d.classList.remove("show")}function x(a){a===1?(I.classList.add("active"),B.classList.remove("active"),L.textContent="Let's Get Started!",b.textContent="Tell us a bit about yourself",i.classList.add("active"),i.classList.remove("completed"),P.classList.remove("active"),S.classList.remove("completed")):a===2&&(I.classList.remove("active"),B.classList.add("active"),L.textContent="Create Your Account",b.textContent="Choose your username and password",i.classList.remove("active"),i.classList.add("completed"),P.classList.add("active"),S.classList.add("completed")),y()}async function F(a){try{const{data:s,error:e}=await l.from("user_profiles").select("email").eq("email",a).maybeSingle();if(e&&e.code!=="PGRST116")throw e;return!s}catch(s){return console.error("Error checking email:",s),!1}}R.addEventListener("submit",async a=>{a.preventDefault(),y();const s=document.getElementById("studentAge").value,e=document.getElementById("parentEmail").value.trim();if(!s){t("Please select your age");return}if(!e){t("Please enter your parent's email");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){t("Please enter a valid email address");return}r.age=parseInt(s),r.parentEmail=e,x(2)});U.addEventListener("click",()=>{x(1)});M.addEventListener("submit",async a=>{a.preventDefault(),y();const s=document.getElementById("firstName").value.trim(),e=document.getElementById("email").value.trim(),o=document.getElementById("password").value,C=document.getElementById("captcha").value;if(!s){t("Please enter your first name");return}if(!e){t("Please enter your email address");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){t("Please enter a valid email address");return}if(!o||o.length<6){t("Password must be at least 6 characters long");return}if(C!=="8"){t("Incorrect answer. Please try again. What is 5 + 3?"),document.getElementById("captcha").value="";return}const m=document.getElementById("signupBtn"),u=document.getElementById("signupBtnText");m.disabled=!0,u.innerHTML='<span class="loading-spinner"></span>Creating Account...';try{if(!await F(e)){t("This email is already registered. Please use a different email or log in."),m.disabled=!1,u.textContent="Sign Up";return}let p=null;const{data:E,error:g}=await l.from("user_profiles").select("id, account_type").eq("email",r.parentEmail).eq("account_type","parent").maybeSingle();g&&g.code!=="PGRST116"&&console.error("Error looking up parent:",g),E&&(p=E.id);const{data:v,error:h}=await l.auth.signUp({email:e,password:o,options:{data:{account_type:"student",first_name:s}}});if(h)throw h;if(v.user){const w={id:v.user.id,email:e,account_type:"student",first_name:s,age:r.age,parent_email:r.parentEmail};p&&(w.parent_id=p);const{error:f}=await l.from("user_profiles").insert(w);if(f)throw console.error("Error creating profile:",f),f;localStorage.setItem("newStudentSignup","true"),localStorage.setItem("studentEmail",e),D("Account created successfully! Redirecting to avatar selection..."),setTimeout(()=>{window.location.href="avatar-selection.html"},1500)}}catch(n){console.error("Signup error:",n),n.message.includes("User already registered")||n.message.includes("duplicate key")?t("This email is already registered. Please use a different email or log in."):n.message.includes("violates check constraint")?t("Unable to create student account. Please ensure your parent has registered first."):t(n.message||"An error occurred. Please try again.")}finally{m.disabled=!1,u.textContent="Sign Up"}});
