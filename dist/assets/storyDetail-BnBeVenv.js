import"./config-N_0HKkEA.js";import{getStoryById as I,getStoryProgressSummary as w,logAnalyticsEvent as C}from"./story-services-RJgnPI-H.js";import"./logo-handler-BTCRg4Zu.js";import{_ as y}from"./preload-helper-BXl3LOEh.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const B=new URLSearchParams(window.location.search),a=B.get("storyId"),l=document.getElementById("storyTitle"),c=document.getElementById("storySummary"),P=document.getElementById("storyLongSummary"),g=document.getElementById("storyCover"),v=document.getElementById("storyTopic"),x=document.getElementById("storyReadingLevel"),f=document.getElementById("storyTime"),i=document.getElementById("progressLabel"),s=document.getElementById("startStoryBtn"),d=document.getElementById("resumeStoryBtn"),p=document.getElementById("panelPreview"),S=document.getElementById("panelPreviewTemplate"),L=document.getElementById("openChatBtn");function T(t){p.innerHTML="",t.slice(0,4).forEach((n,e)=>{const o=S.content.cloneNode(!0);o.querySelector("[data-panelId]").textContent=`#${e+1}`,o.querySelector("[data-panelText]").textContent=n.narration,p.appendChild(o)})}function _(t,n){const e=t?.lastPanelIndex>0;!!t?.completedAt?i.textContent="Completed â€“ great job!":e?i.textContent=`You paused at panel ${Math.min(t.lastPanelIndex+1,n)}.`:i.textContent="You have not started this adventure yet.",d.classList.toggle("hidden",!e),s.textContent=e?"Restart Story":"Start Story"}function b(t,n){const e=n?.lastPanelIndex??0,o=Math.min(e,t.length-1),m=(r=0)=>{const E=`/stories/reader.html?storyId=${a}&panel=${r}`;window.location.href=E};s.addEventListener("click",()=>m(0)),d.addEventListener("click",()=>m(o));const u=t[o]?.chatTopicId||t[0]?.chatTopicId;L.addEventListener("click",()=>{const r=new URL("../chat/index.html",window.location.origin);u&&r.searchParams.set("topicId",u),r.searchParams.set("storyRef",a),window.location.href=`${r.pathname}${r.search}`})}async function R(){if(!a){l.textContent="Story not found",c.textContent="Missing story reference. Please return to the story list.",s.disabled=!0;return}try{const t=await I(a);if(!t)throw new Error("Story not found");l.textContent=t.title,c.textContent=t.summary,P.textContent=t.summary,v.textContent=t.topicTag||"Science",x.textContent=t.readingLevel||"Ages 7-10",f.textContent=t.estimatedTime||"6 min read",g.src=t.coverUrl||"/images/placeholder-story.png",g.alt=t.title;const n=t.panels||[];T(n);const e=w(a);_(e,n.length||6),b(n,e),await C("story_detail_opened",{storyId:a,lastPanelIndex:e?.lastPanelIndex??0})}catch(t){console.error("[story-detail] Unable to load story",t),l.textContent="Story unavailable",c.textContent="We could not load this adventure. Please try again later.",s.disabled=!0,d.disabled=!0}}R();const h=async()=>{try{const{createClient:t}=await y(async()=>{const{createClient:e}=await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm");return{createClient:e}},[]),{supabaseConfig:n}=await y(async()=>{const{supabaseConfig:e}=await import("./config-N_0HKkEA.js");return{supabaseConfig:e}},[]);if(n?.url&&n?.anonKey){const e=t(n.url,n.anonKey),{error:o}=await e.auth.signOut();if(o)throw o}}catch{console.log("Supabase logout skipped (mock mode)")}localStorage.clear(),sessionStorage.clear(),window.location.href="../auth/auth.html"};document.getElementById("logoutBtn")?.addEventListener("click",h);document.getElementById("logoutBtnMobile")?.addEventListener("click",h);
