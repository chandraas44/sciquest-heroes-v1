import{supabaseConfig as N}from"./config-CMljicwL.js";import{createClient as j}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const G=N.url,q=N.anonKey;(!G||!q)&&console.error("Missing Supabase configuration");const g=j(G,q);let f=!1,t="";const H=new URLSearchParams(window.location.search),K=H.get("mode"),B=H.get("type");K==="signup"&&(f=!0),t=B||localStorage.getItem("accountType")||"";const C=document.getElementById("authTitle"),R=document.getElementById("authSubtitle"),b=document.getElementById("submitBtnText"),k=document.getElementById("googleBtnText"),U=document.getElementById("toggleText"),T=document.getElementById("toggleModeLink"),A=document.getElementById("forgotPasswordContainer"),Q=document.getElementById("authForm"),S=document.getElementById("googleSignInBtn"),M=document.getElementById("divider"),E=document.getElementById("errorMessage"),L=document.getElementById("successMessage"),$=document.getElementById("modeToggleTop"),F=document.getElementById("modeToggleTopText"),_=document.getElementById("modeToggleIcon");function x(){const e=t==="student";S&&(S.style.display=e?"none":"flex"),M&&(M.style.display=e?"none":"flex"),f?(C.textContent="Create a free account",R.textContent=`Join SciQuest Heroes as a ${t||"member"}`,b.textContent="Sign Up",k.textContent="Sign up with Google",U.textContent="Already have an account?",T.textContent="Log In",F.textContent="Log In",_.className="fas fa-sign-in-alt",A.style.display="none"):(C.textContent="Welcome Back!",R.textContent="Sign in to continue your adventure",b.textContent="Log In",k.textContent="Continue with Google",U.textContent="Don't have an account?",T.textContent="Sign Up",F.textContent="Sign Up",_.className="fas fa-user-plus",A.style.display="block")}x();function O(e){e.preventDefault(),f=!f,x(),I()}T.addEventListener("click",O);$.addEventListener("click",O);function c(e){E.textContent=e,E.classList.add("show"),L.classList.remove("show")}function i(e){L.textContent=e,L.classList.add("show"),E.classList.remove("show")}function I(){E.classList.remove("show"),L.classList.remove("show")}function D(e){const r=document.getElementById("submitBtn"),s=document.getElementById("googleSignInBtn");e?(r.disabled=!0,s.disabled=!0,b.innerHTML='<span class="loading-spinner"></span>Processing...'):(r.disabled=!1,s.disabled=!1,b.textContent=f?"Sign Up":"Log In")}async function W(e,r,s){try{const{data:a}=await g.from("user_profiles").select("*").eq("id",e).maybeSingle();if(a){console.log("User profile already exists");return}const{error:l}=await g.from("user_profiles").insert({id:e,email:r,account_type:s||"student"});if(l){if(l.code==="23505"){console.log("User profile already exists (duplicate key)");return}throw console.error("Error creating user profile:",l),l}}catch(a){throw console.error("Failed to create user profile:",a),a}}Q.addEventListener("submit",async e=>{var a,l,u,n,p,w,P;e.preventDefault(),I();const r=document.getElementById("email").value.trim(),s=document.getElementById("password").value;if(!r||!s){c("Please fill in all fields");return}if(s.length<6){c("Password must be at least 6 characters long");return}D(!0);try{if(f){const{data:o,error:h}=await g.auth.signUp({email:r,password:s});if(h)throw h;if(o.user){await W(o.user.id,r,t),i("Account created successfully! Redirecting...");const m=t||"student";localStorage.removeItem("accountType"),setTimeout(()=>{m==="parent"?window.location.href="../dashboards/parent-dashboard.html":m==="teacher"?window.location.href="../dashboards/teacher-dashboard.html":m==="student"?window.location.href="../dashboards/student-dashboard.html":window.location.href="../index.html"},1500)}}else{console.log("=== Login Attempt ==="),console.log("Email:",r),console.log("Account type from context:",t||"not specified");const{data:o,error:h}=await g.auth.signInWithPassword({email:r,password:s});if(h)throw console.error("=== Authentication Error ==="),console.error("Error:",h),console.error("Error message:",h.message),h;if(o.user){console.log("=== Authentication Successful ==="),console.log("User ID:",o.user.id),console.log("User email:",o.user.email),console.log("Fetching user profile...");const{data:m,error:d}=await g.from("user_profiles").select("account_type").eq("id",o.user.id).maybeSingle();if(d){if(console.error("=== Profile Fetch Error ==="),console.error("Error object:",d),console.error("Error details:",{code:d.code,message:d.message,details:d.details,hint:d.hint,userId:o.user.id,userEmail:o.user.email,accountTypeFromContext:t,timestamp:new Date().toISOString()}),d.code==="42501"||((a=d.message)==null?void 0:a.toLowerCase().includes("permission denied"))||((l=d.message)==null?void 0:l.toLowerCase().includes("policy"))||((u=d.message)==null?void 0:u.toLowerCase().includes("row-level security"))){console.error("=== RLS Policy Error Detected ==="),console.error("This indicates a Row Level Security (RLS) policy configuration issue."),console.error("The user is authenticated but cannot read their own profile from user_profiles table."),console.error("Possible causes:"),console.error('  1. Missing "Users can read own profile" policy'),console.error("  2. Conflicting RLS policies"),console.error("  3. Recursive RLS checks in parent-child policies"),console.error("Solution: Run fix_rls_login_error.sql in Supabase SQL Editor");const v="RLS-"+Date.now();console.error("Error code for support:",v),c(`Account access error. Please contact support with error code: ${v}. This is a database configuration issue that needs to be fixed by an administrator.`)}else console.warn("Non-RLS profile fetch error, attempting fallback based on account type context"),t==="student"?(console.warn("Profile fetch error, redirecting to student dashboard (fallback)"),i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/student-dashboard.html"},1500)):t==="parent"?(console.warn("Profile fetch error, redirecting to parent dashboard (fallback)"),i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/parent-dashboard.html"},1500)):t==="teacher"?(console.warn("Profile fetch error, redirecting to teacher dashboard (fallback)"),i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/teacher-dashboard.html"},1500)):(console.warn("Profile fetch error, showing error message (no fallback available)"),c("Unable to load your account profile. Please try again or contact support."));return}if(!m){console.warn("User profile not found in database, attempting fallback based on account type context"),console.warn("Profile lookup details:",{userId:o.user.id,userEmail:o.user.email,accountTypeFromContext:t}),t==="student"?(console.warn("User profile not found, redirecting to student dashboard (fallback)"),i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/student-dashboard.html"},1500)):t==="parent"?(console.warn("User profile not found, redirecting to parent dashboard (fallback)"),i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/parent-dashboard.html"},1500)):t==="teacher"?(console.warn("User profile not found, redirecting to teacher dashboard (fallback)"),i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/teacher-dashboard.html"},1500)):(console.warn("User profile not found, showing error message (no fallback available)"),c("User profile not found. Please contact support to set up your account."));return}if(!m.account_type){console.warn("Account type missing in profile, attempting fallback based on account type context"),console.warn("Profile data:",{userId:o.user.id,userEmail:o.user.email,profileData:m,accountTypeFromContext:t}),t==="student"?(console.warn("Account type missing in profile, redirecting to student dashboard (fallback)"),i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/student-dashboard.html"},1500)):t==="parent"?(console.warn("Account type missing in profile, redirecting to parent dashboard (fallback)"),i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/parent-dashboard.html"},1500)):t==="teacher"?(console.warn("Account type missing in profile, redirecting to teacher dashboard (fallback)"),i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/teacher-dashboard.html"},1500)):(console.warn("Account type missing in profile, showing error message (no fallback available)"),c("Account type is missing from your profile. Please contact support."));return}const y=m.account_type.toLowerCase().trim();if(console.log("=== Profile Retrieved Successfully ==="),console.log("User account type from profile:",y),console.log("Account type from context:",t),y==="parent"){i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/parent-dashboard.html"},1500);return}else if(y==="teacher"){i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/teacher-dashboard.html"},1500);return}else if(y==="student"){i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/student-dashboard.html"},1500);return}else t==="student"?(console.warn("Invalid account_type:",y,"redirecting to student dashboard"),i("Login successful! Redirecting..."),setTimeout(()=>{window.location.href="../dashboards/student-dashboard.html"},1500)):(console.warn("Invalid account_type:",y,"showing error message"),c("Invalid account type detected. Please contact support."))}}}catch(o){console.error("=== Authentication Flow Error ==="),console.error("Error object:",o),console.error("Error message:",o.message),console.error("Error code:",o.code),console.error("Error details:",o.details),console.error("Error hint:",o.hint),console.error("Mode:",f?"Sign Up":"Login"),console.error("Account type context:",t||"not specified"),console.error("Timestamp:",new Date().toISOString()),(n=o.message)!=null&&n.includes("Invalid login credentials")?(console.warn("Invalid credentials provided"),c("Invalid email or password. Please try again.")):(p=o.message)!=null&&p.includes("User already registered")?(console.warn("User attempted to sign up with existing email"),c("This email is already registered. Please log in instead."),setTimeout(()=>{f=!1,x(),I()},2e3)):(w=o.message)!=null&&w.includes("Email not confirmed")?(console.warn("User email not confirmed"),c("Please check your email to confirm your account.")):(P=o.message)!=null&&P.includes("duplicate key")?(console.warn("Duplicate key error - user profile may already exist"),c("This account already exists. Please log in instead.")):(console.error("Unhandled authentication error"),c(o.message||"An error occurred. Please try again."))}finally{D(!1)}});S.addEventListener("click",async()=>{if(I(),t==="student"){c("Google sign-in is not available for student accounts. Please use email and password.");return}try{const{data:e,error:r}=await g.auth.signInWithOAuth({provider:"google",options:{redirectTo:window.location.origin+"/index.html",queryParams:{prompt:"select_account"}}});if(r)throw r}catch(e){console.error("Google sign-in error:",e),c("Failed to sign in with Google. Please try again.")}});document.getElementById("forgotPasswordLink").addEventListener("click",e=>{e.preventDefault(),J()});function J(){const e=document.getElementById("forgotPasswordModal");e.style.display="flex",document.getElementById("resetEmail").value=document.getElementById("email").value}window.closeForgotPasswordModal=function(){const e=document.getElementById("forgotPasswordModal");e.style.display="none",document.getElementById("resetErrorMessage").classList.remove("show"),document.getElementById("resetSuccessMessage").classList.remove("show")};document.getElementById("resetPasswordForm").addEventListener("submit",async e=>{e.preventDefault();const r=document.getElementById("resetEmail").value.trim(),s=document.getElementById("resetErrorMessage"),a=document.getElementById("resetSuccessMessage"),l=document.getElementById("resetSubmitBtn"),u=document.getElementById("resetBtnText");if(!r){s.textContent="Please enter your email address",s.classList.add("show");return}l.disabled=!0,u.innerHTML='<span class="loading-spinner"></span>Sending...';try{const{error:n}=await g.auth.resetPasswordForEmail(r,{redirectTo:window.location.origin+"/auth/auth.html"});if(n)throw n;a.textContent="Password reset email sent! Check your inbox.",a.classList.add("show"),s.classList.remove("show"),setTimeout(()=>{closeForgotPasswordModal()},3e3)}catch(n){console.error("Password reset error:",n),s.textContent=n.message||"Failed to send reset email. Please try again.",s.classList.add("show"),a.classList.remove("show")}finally{l.disabled=!1,u.textContent="Send Reset Link"}});g.auth.onAuthStateChange((e,r)=>{(async()=>{var s,a,l;if(e==="SIGNED_IN"&&r){console.log("=== Auth State Change: SIGNED_IN ==="),console.log("User ID:",r.user.id),console.log("User email:",r.user.email);const{data:u,error:n}=await g.from("user_profiles").select("*").eq("id",r.user.id).maybeSingle();if(n&&(console.error("=== Profile Fetch Error in Auth State Change ==="),console.error("Error:",n),console.error("Error code:",n.code),console.error("Error message:",n.message),(n.code==="42501"||(s=n.message)!=null&&s.toLowerCase().includes("permission denied")||(a=n.message)!=null&&a.toLowerCase().includes("policy")||(l=n.message)!=null&&l.toLowerCase().includes("row-level security"))&&(console.error("RLS policy error detected in auth state change handler"),console.error("This may prevent profile creation. Check RLS policies."))),u)console.log("Profile found during auth state change:",{accountType:u.account_type,email:u.email});else{console.warn("Profile not found during auth state change, attempting to create");const p=t||localStorage.getItem("accountType")||"student";console.log("Creating profile with account type:",p);try{await W(r.user.id,r.user.email,p),console.log("Profile created successfully during auth state change")}catch(w){console.error("=== Error creating profile during auth state change ==="),console.error("Error:",w),console.error("Error code:",w.code),console.error("Error message:",w.message),console.error("This may indicate an RLS policy issue for INSERT operations")}}}})()});
