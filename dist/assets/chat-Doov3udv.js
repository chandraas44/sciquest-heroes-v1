const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/story-services-DPdubSP2.js","assets/config-ClyacVFi.js"])))=>i.map(i=>d[i]);
import{s as C}from"./config-ClyacVFi.js";import{createClient as Y}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const J="modulepreload",G=function(e){return"/"+e},D={},Q=function(t,n,a){let s=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),i=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=Promise.allSettled(n.map(c=>{if(c=G(c),c in D)return;D[c]=!0;const p=c.endsWith(".css"),b=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${b}`))return;const d=document.createElement("link");if(d.rel=p?"stylesheet":J,p||(d.as="script"),d.crossOrigin="",d.href=c,i&&d.setAttribute("nonce",i),document.head.appendChild(d),p)return new Promise((W,K)=>{d.addEventListener("load",W),d.addEventListener("error",()=>K(new Error(`Unable to preload CSS for ${c}`)))})}))}function l(r){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=r,window.dispatchEvent(i),!i.defaultPrevented)throw r}return s.then(r=>{for(const i of r||[])i.status==="rejected"&&l(i.reason);return t().catch(l)})},h={},B=(h==null?void 0:h.VITE_EDGE_ANALYTICS_URL)||"",V=((h==null?void 0:h.VITE_USE_CHAT_MOCKS)??"true")==="true",M="guest-child",A="sqh_chat_transcripts_v1",N="sqh_analytics_queue_v1";let k=null,y=null;function U(){var e;return!!((e=C)!=null&&e.url)}function m(){return U()?(k||(k=Y(C.url,C.anonKey)),k):null}function f(){return V?!0:!U()}function z(){return f()}async function u(){if(y)return y;const e=await fetch(new URL("/assets/mockChatData-ChBBNlBd.json",import.meta.url));if(!e.ok)throw new Error("Unable to load mock chat data");return y=await e.json(),y}async function X(){if(f())return(await u()).topics||[];const e=m();if(!e)return(await u()).topics||[];try{const{data:t,error:n}=await e.from("topics").select("*").eq("enabled",!0).order("name");if(n)throw n;return t||[]}catch(t){return console.warn("[chat] Supabase topics fetch failed, reverting to mock data",t),(await u()).topics||[]}}async function Z(e){if(!e)throw new Error("topicId is required");if(f())return(await u()).topics.find(a=>a.id===e)||null;const t=m();if(!t)return(await u()).topics.find(a=>a.id===e)||null;try{const{data:n,error:a}=await t.from("topics").select("*").eq("id",e).eq("enabled",!0).maybeSingle();if(a||!n)throw a||new Error("topic not found");return n}catch(n){return console.warn("[chat] Supabase topic fetch failed, reverting to mock data",n),(await u()).topics.find(s=>s.id===e)||null}}function v(e,t){return new Promise(async n=>{var c;const s=(c=(await u()).responses)==null?void 0:c[e];if(!s){n((s==null?void 0:s.default)||"That's a great question! I'm here to help you learn. What else would you like to know? ü§î");return}const l=t.toLowerCase();let r=null;for(const[p,b]of Object.entries(s.patterns||{}))if(new RegExp(p,"i").test(l)){r=b;break}const i=r||s.default||"That's a great question! I'm here to help you learn. What else would you like to know? ü§î";setTimeout(()=>{n(i)},1e3+Math.random()*1e3)})}async function ee(e,t,n={}){if(!(await te(t)).safe)return{role:"ai",content:"I can't answer that question right now. Would you like to ask a parent or teacher for help?",timestamp:new Date().toISOString(),safetyFlagged:!0};if(f())return{role:"ai",content:await v(e,t),timestamp:new Date().toISOString(),safetyFlagged:!1};const s=m();if(!s)return{role:"ai",content:await v(e,t),timestamp:new Date().toISOString(),safetyFlagged:!1};try{const{data:l,error:r}=await s.rpc("get_ai_response",{p_topic_id:e,p_message:t,p_context:n});if(r)throw r;return{role:"ai",content:l.response||"I'm not sure how to answer that. Can you try asking it differently?",timestamp:new Date().toISOString(),safetyFlagged:!1}}catch(l){return console.warn("[chat] Supabase AI call failed, reverting to mock",l),{role:"ai",content:await v(e,t),timestamp:new Date().toISOString(),safetyFlagged:!1}}}async function te(e){if(f())return{safe:!0};const t=m();if(!t)return{safe:!0};try{const{data:n,error:a}=await t.rpc("check_message_safety",{p_message:e});if(a)throw a;return{safe:(n==null?void 0:n.safe)??!0,reason:n==null?void 0:n.reason}}catch(n){return console.warn("[chat] Safety filter check failed, defaulting to safe",n),{safe:!0}}}function H(){if(typeof window>"u")return{};try{const e=window.localStorage.getItem(A);return e?JSON.parse(e):{}}catch(e){return console.warn("[chat] Unable to read transcript store",e),{}}}function ne(e){if(!(typeof window>"u"))try{window.localStorage.setItem(A,JSON.stringify(e))}catch(t){console.warn("[chat] Unable to write transcript store",t)}}function F(e,t){if(!e)throw new Error("sessionId is required");const n=H();n[e]={...t,updatedAt:new Date().toISOString()},ne(n);const a=m();a&&!f()&&a.from("chat_sessions").upsert({session_id:e,child_id:t.childId||M,topic_id:t.topicId,messages:t.messages,context:t.context,updated_at:new Date().toISOString()}).catch(s=>{console.warn("[chat] Supabase transcript save failed",s)})}function oe(e){return e&&H()[e]||null}function ae(){return`chat_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function se(){if(typeof window>"u")return[];try{const e=window.localStorage.getItem(N);return e?JSON.parse(e):[]}catch(e){return console.warn("[chat] Failed to read analytics queue",e),[]}}function re(e){if(!(typeof window>"u"))try{window.localStorage.setItem(N,JSON.stringify(e))}catch(t){console.warn("[chat] Failed to update analytics queue",t)}}function ie(e){const t=se();t.push(e),re(t)}async function ce(e){if(!B)return!1;try{return(await fetch(B,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok}catch(t){return console.warn("[chat] Edge analytics call failed",t),!1}}async function w(e,t={}){const n={eventType:`chat_${e}`,payload:{...t,childId:M},timestamp:new Date().toISOString()};if(B&&await ce(n))return;ie(n);const a=m();a&&!f()&&a.from("analytics_events").insert({event_type:n.eventType,payload:n.payload,occurred_at:n.timestamp}).catch(s=>{console.warn("[chat] Supabase analytics insert failed",s)})}const R=new URLSearchParams(window.location.search),T=R.get("topicId"),le=R.get("storyRef"),de=R.get("panelId"),o={topicId:null,topic:null,messages:[],isLoading:!1,context:{storyRef:le||null,panelId:de||null},sessionId:null,storyTitle:null},S=document.getElementById("topicPicker"),q=document.getElementById("chatSession");document.getElementById("chatHeader");const ue=document.getElementById("topicName"),I=document.getElementById("contextBadge"),g=document.getElementById("chatWindow"),E=document.getElementById("messageInput"),_=document.getElementById("sendBtn"),L=document.getElementById("quickPrompts");document.getElementById("safetyBanner");const fe=document.getElementById("escalationBtn"),pe=document.getElementById("backBtn"),P=document.getElementById("offlineBanner");function O(){if(!P)return;const e=z()||navigator.onLine===!1;P.classList.toggle("hidden",!e)}function he(e){S.innerHTML="",e.forEach(t=>{const n=document.createElement("div");n.className="bg-white/5 backdrop-blur-xl border border-white/10 rounded-3xl p-6 cursor-pointer hover:bg-white/10 transition shadow-xl",n.innerHTML=`
      <div class="text-6xl mb-4">${t.icon}</div>
      <h3 class="font-fredoka text-2xl text-white mb-2">${t.name}</h3>
      <p class="text-white/70 text-sm mb-4">${t.description}</p>
      <button class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold py-3 rounded-2xl hover:from-purple-600 hover:to-pink-600 transition">
        Start Chat
      </button>
    `,n.querySelector("button").addEventListener("click",()=>{window.location.href=`./index.html?topicId=${t.id}`}),S.appendChild(n)})}function me(e,t=!1){const n=document.createElement("div"),a=e.role==="user";return n.className=`flex ${a?"justify-end":"justify-start"} mb-4`,t&&!a?n.innerHTML=`
      <div class="max-w-[80%] bg-white border-2 border-slate-200 text-slate-800 rounded-3xl px-5 py-3 shadow-lg">
        <div class="flex items-center gap-2">
          <div class="flex gap-1">
            <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
          </div>
          <span class="text-sm text-slate-500">Thinking...</span>
        </div>
      </div>
    `:n.innerHTML=`
      <div class="max-w-[80%] ${a?"bg-gradient-to-br from-purple-500 to-pink-500 text-white":"bg-white border-2 border-slate-200 text-slate-800"} rounded-3xl px-5 py-3 shadow-lg">
        <p class="text-sm leading-relaxed">${e.content}</p>
      </div>
    `,n}function x(){g.innerHTML="",o.messages.forEach((e,t)=>{const n=o.isLoading&&t===o.messages.length-1&&e.role==="ai"&&e.content==="...";g.appendChild(me(e,n))}),g.scrollTop=g.scrollHeight}function ge(){var e;if(!((e=o.topic)!=null&&e.quickPrompts)){L.innerHTML="";return}L.innerHTML="",o.topic.quickPrompts.forEach((t,n)=>{const a=document.createElement("button");a.className="px-4 py-2 bg-white/10 border border-white/20 text-white rounded-full text-sm font-semibold hover:bg-white/20 transition",a.textContent=t,a.addEventListener("click",async()=>{E.value=t,await w("quick_prompt_used",{topicId:o.topicId,promptIndex:n}),$()}),L.appendChild(a)})}function j(){if(!o.context.storyRef){I.classList.add("hidden");return}I.classList.remove("hidden");let e="";if(o.context.panelId){const n=o.context.panelId.replace(/^panel-?/i,"").replace(/^panel/i,"");n&&(e=` - Panel ${n}`)}const t=o.storyTitle?`From: ${o.storyTitle}${e}`:`From story: ${o.context.storyRef}${e}`;I.textContent=t,I.onclick=()=>{if(o.context.storyRef){let n="";if(o.context.panelId){const a=o.context.panelId.replace(/^panel-?/i,"").replace(/^panel/i,"");a&&(n=`?panel=${a}`)}window.location.href=`/stories/${o.context.storyRef}/read${n}`}}}async function $(){var s;const e=E.value.trim();if(!e||o.isLoading)return;const t={role:"user",content:e,timestamp:new Date().toISOString()};o.messages.push(t),x(),E.value="",_.disabled=!0,o.isLoading=!0;const n={role:"ai",content:"...",timestamp:new Date().toISOString()};o.messages.push(n),x(),await w("message_sent",{topicId:o.topicId,messageLength:e.length,hasContext:!!o.context.storyRef});const a=await ee(o.topicId,e,o.context);o.messages.pop(),o.messages.push(a),x(),o.isLoading=!1,_.disabled=!1,F(o.sessionId,{topicId:o.topicId,messages:o.messages,context:o.context,childId:"guest-child",createdAt:((s=o.messages[0])==null?void 0:s.timestamp)||new Date().toISOString()})}async function we(e){if(e)try{const{getStoryById:t}=await Q(async()=>{const{getStoryById:a}=await import("./story-services-DPdubSP2.js");return{getStoryById:a}},__vite__mapDeps([0,1])),n=await t(e);n&&(o.storyTitle=n.title,j())}catch(t){console.warn("[chat] Could not load story title",t)}}async function ye(){var n;if(!T){const a=await X();he(a),S.classList.remove("hidden"),q.classList.add("hidden");return}S.classList.add("hidden"),q.classList.remove("hidden");const e=await Z(T);if(!e){g.innerHTML=`
      <div class="text-center py-12">
        <p class="text-white text-lg mb-4">Topic not found. Please go back and select a topic.</p>
        <button onclick="window.location.href='./index.html'" class="px-6 py-3 bg-purple-600 text-white rounded-2xl font-semibold hover:bg-purple-500 transition">
          Go to Topic List
        </button>
      </div>
    `;return}o.topicId=T,o.topic=e,o.sessionId=ae(),ue.textContent=e.name;const t=oe(o.sessionId);if(t&&t.messages)o.messages=t.messages;else{const a={role:"ai",content:`Hi! I'm here to help you learn about ${e.name}! ${e.icon} What would you like to know?`,timestamp:new Date().toISOString()};o.messages=[a]}x(),ge(),j(),o.context.storyRef&&await we(o.context.storyRef),await w("chat_started",{topicId:o.topicId,storyRef:o.context.storyRef,panelId:o.context.panelId}),F(o.sessionId,{topicId:o.topicId,messages:o.messages,context:o.context,childId:"guest-child",createdAt:((n=o.messages[0])==null?void 0:n.timestamp)||new Date().toISOString()})}_.addEventListener("click",$);E.addEventListener("keypress",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),$())});pe.addEventListener("click",async()=>{if(o.sessionId&&o.topicId&&await w("chat_session_ended",{topicId:o.topicId,messageCount:o.messages.length}),o.context.storyRef){let e="";if(o.context.panelId){const t=o.context.panelId.replace(/^panel-?/i,"").replace(/^panel/i,"");t&&(e=`?panel=${t}`)}window.location.href=`/stories/${o.context.storyRef}/read${e}`}else window.location.href="./index.html"});fe.addEventListener("click",()=>{w("escalation_clicked",{topicId:o.topicId}),alert("That's a great question! You can ask a parent or teacher for help with this. They'll be happy to explain it to you! üë®‚Äçüë©‚Äçüëß‚Äçüë¶")});O();window.addEventListener("online",O);window.addEventListener("offline",O);ye();
