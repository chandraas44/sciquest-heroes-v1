const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/story-services-RJgnPI-H.js","assets/config-N_0HKkEA.js"])))=>i.map(i=>d[i]);
import{supabaseConfig as w}from"./config-N_0HKkEA.js";import{_ as S}from"./preload-helper-BXl3LOEh.js";import{createClient as K}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";import{evaluateBadgeRules as j,getBadgeById as V}from"./badge-services-BEYCrsbD.js";import{s as W}from"./badge-celebration-C4tXiTtu.js";import"./logo-handler-BTCRg4Zu.js";const D={},v=D?.VITE_EDGE_ANALYTICS_URL||"",Y=(D?.VITE_USE_CHAT_MOCKS??"true")==="true",O="guest-child",M="sqh_chat_transcripts_v1",A="sqh_analytics_queue_v1";let x=null,m=null;function $(){return!!(w?.url&&w?.anonKey)}function d(){return $()?(x||(x=K(w.url,w.anonKey)),x):null}function l(){return Y?!0:!$()}function J(){return l()}async function c(){if(m)return m;const e=await fetch(new URL("/assets/mockChatData-BZc2Vt9w.json",import.meta.url));if(!e.ok)throw new Error("Unable to load mock chat data");return m=await e.json(),m}async function G(){if(l())return(await c()).topics||[];const e=d();if(!e)return(await c()).topics||[];try{const{data:t,error:n}=await e.from("topics").select("*").eq("enabled",!0).order("name");if(n)throw n;return t||[]}catch(t){return console.warn("[chat] Supabase topics fetch failed, reverting to mock data",t),(await c()).topics||[]}}async function Q(e){if(!e)throw new Error("topicId is required");if(l())return(await c()).topics.find(o=>o.id===e)||null;const t=d();if(!t)return(await c()).topics.find(o=>o.id===e)||null;try{const{data:n,error:o}=await t.from("topics").select("*").eq("id",e).eq("enabled",!0).maybeSingle();if(o||!n)throw o||new Error("topic not found");return n}catch(n){return console.warn("[chat] Supabase topic fetch failed, reverting to mock data",n),(await c()).topics.find(s=>s.id===e)||null}}function _(e,t){return new Promise(async n=>{const s=(await c()).responses?.[e];if(!s){n(s?.default||"That's a great question! I'm here to help you learn. What else would you like to know? ðŸ¤”");return}const r=t.toLowerCase();let i=null;for(const[H,U]of Object.entries(s.patterns||{}))if(new RegExp(H,"i").test(r)){i=U;break}const u=i||s.default||"That's a great question! I'm here to help you learn. What else would you like to know? ðŸ¤”";setTimeout(()=>{n(u)},1e3+Math.random()*1e3)})}async function Z(e,t,n={}){if(!(await z(t)).safe)return{role:"ai",content:"I can't answer that question right now. Would you like to ask a parent or teacher for help?",timestamp:new Date().toISOString(),safetyFlagged:!0};if(l())return{role:"ai",content:await _(e,t),timestamp:new Date().toISOString(),safetyFlagged:!1};const s=d();if(!s)return{role:"ai",content:await _(e,t),timestamp:new Date().toISOString(),safetyFlagged:!1};try{const{data:r,error:i}=await s.rpc("get_ai_response",{p_topic_id:e,p_message:t,p_context:n});if(i)throw i;return{role:"ai",content:r.response||"I'm not sure how to answer that. Can you try asking it differently?",timestamp:new Date().toISOString(),safetyFlagged:!1}}catch(r){return console.warn("[chat] Supabase AI call failed, reverting to mock",r),{role:"ai",content:await _(e,t),timestamp:new Date().toISOString(),safetyFlagged:!1}}}async function z(e){if(l())return{safe:!0};const t=d();if(!t)return{safe:!0};try{const{data:n,error:o}=await t.rpc("check_message_safety",{p_message:e});if(o)throw o;return{safe:n?.safe??!0,reason:n?.reason}}catch(n){return console.warn("[chat] Safety filter check failed, defaulting to safe",n),{safe:!0}}}function q(){if(typeof window>"u")return{};try{const e=window.localStorage.getItem(M);return e?JSON.parse(e):{}}catch(e){return console.warn("[chat] Unable to read transcript store",e),{}}}function X(e){if(!(typeof window>"u"))try{window.localStorage.setItem(M,JSON.stringify(e))}catch(t){console.warn("[chat] Unable to write transcript store",t)}}function F(e,t){if(!e)throw new Error("sessionId is required");const n=q();n[e]={...t,updatedAt:new Date().toISOString()},X(n);const o=d();o&&!l()&&o.from("chat_sessions").upsert({session_id:e,child_id:t.childId||O,topic_id:t.topicId,messages:t.messages,context:t.context,updated_at:new Date().toISOString()}).catch(s=>{console.warn("[chat] Supabase transcript save failed",s)})}function ee(e){return e&&q()[e]||null}function te(){return`chat_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function ne(){if(typeof window>"u")return[];try{const e=window.localStorage.getItem(A);return e?JSON.parse(e):[]}catch(e){return console.warn("[chat] Failed to read analytics queue",e),[]}}function ae(e){if(!(typeof window>"u"))try{window.localStorage.setItem(A,JSON.stringify(e))}catch(t){console.warn("[chat] Failed to update analytics queue",t)}}function oe(e){const t=ne();t.push(e),ae(t)}async function se(e){if(!v)return!1;try{return(await fetch(v,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok}catch(t){return console.warn("[chat] Edge analytics call failed",t),!1}}async function f(e,t={}){const n={eventType:`chat_${e}`,payload:{...t,childId:O},timestamp:new Date().toISOString()};if(v&&await se(n))return;oe(n);const o=d();o&&!l()&&o.from("analytics_events").insert({event_type:n.eventType,payload:n.payload,occurred_at:n.timestamp}).catch(s=>{console.warn("[chat] Supabase analytics insert failed",s)})}const T=new URLSearchParams(window.location.search),b=T.get("topicId"),re=T.get("storyRef"),ie=T.get("panelId"),a={topicId:null,topic:null,messages:[],isLoading:!1,context:{storyRef:re||null,panelId:ie||null},sessionId:null,storyTitle:null},y=document.getElementById("topicPicker"),B=document.getElementById("chatSession");document.getElementById("chatHeader");const ce=document.getElementById("topicName"),g=document.getElementById("contextBadge"),p=document.getElementById("chatWindow"),I=document.getElementById("messageInput"),k=document.getElementById("sendBtn"),E=document.getElementById("quickPrompts");document.getElementById("safetyBanner");const le=document.getElementById("escalationBtn"),de=document.getElementById("backBtn"),R=document.getElementById("offlineBanner");function L(){if(!R)return;const e=J()||navigator.onLine===!1;R.classList.toggle("hidden",!e)}function ue(e){y.innerHTML="",e.forEach(t=>{const n=document.createElement("div");n.className="bg-white border-2 border-purple-200 rounded-3xl p-6 cursor-pointer hover:border-purple-300 transition shadow-[0_0_20px_rgba(139,92,246,0.15)] hover:shadow-[0_0_30px_rgba(139,92,246,0.3)]",n.innerHTML=`
      <div class="flex justify-center mb-4">
        <div class="bg-purple-100 p-4 rounded-full border-2 border-purple-200">
          <div class="text-6xl">${t.icon}</div>
        </div>
      </div>
      <h3 class="font-fredoka text-2xl text-slate-700 mb-2 text-center">${t.name}</h3>
      <p class="text-slate-600 text-sm mb-4 text-center">${t.description}</p>
      <button class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-2xl hover:from-purple-600 hover:to-pink-600 transition shadow-lg">
        Start Chat
      </button>
    `,n.querySelector("button").addEventListener("click",()=>{window.location.href=`./index.html?topicId=${t.id}`}),y.appendChild(n)})}function pe(e,t=!1){const n=document.createElement("div"),o=e.role==="user";return n.className=`flex ${o?"justify-end":"justify-start"} mb-4`,t&&!o?n.innerHTML=`
      <div class="max-w-[80%] bg-[#E8D9FF] border-2 border-[#C8AFFF] text-slate-800 rounded-3xl px-5 py-3 shadow-lg">
        <div class="flex items-center gap-2">
          <div class="flex gap-1">
            <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
          </div>
          <span class="text-sm text-purple-700 font-semibold">Thinking...</span>
        </div>
      </div>
    `:n.innerHTML=`
      <div class="max-w-[80%] ${o?"bg-gradient-to-br from-purple-500 to-pink-500 text-white font-bold":"bg-[#E8D9FF] border-2 border-[#C8AFFF] text-slate-800"} rounded-3xl px-5 py-3 shadow-lg">
        <p class="text-sm leading-relaxed">${e.content}</p>
      </div>
    `,n}function h(){p.innerHTML="",a.messages.forEach((e,t)=>{const n=a.isLoading&&t===a.messages.length-1&&e.role==="ai"&&e.content==="...";p.appendChild(pe(e,n))}),p.scrollTop=p.scrollHeight}function fe(){if(!a.topic?.quickPrompts){E.innerHTML="";return}E.innerHTML="",a.topic.quickPrompts.forEach((e,t)=>{const n=document.createElement("button");n.className="px-4 py-2 bg-purple-100 border-2 border-purple-200 text-slate-700 rounded-full text-sm font-semibold hover:bg-purple-200 transition",n.textContent=e,n.addEventListener("click",async()=>{I.value=e,await f("quick_prompt_used",{topicId:a.topicId,promptIndex:t}),C()}),E.appendChild(n)})}function P(){if(!a.context.storyRef){g.classList.add("hidden");return}g.classList.remove("hidden");let e="";if(a.context.panelId){const n=a.context.panelId.replace(/^panel-?/i,"").replace(/^panel/i,"");n&&(e=` - Panel ${n}`)}const t=a.storyTitle?`From: ${a.storyTitle}${e}`:`From story: ${a.context.storyRef}${e}`;g.textContent=t,g.onclick=()=>{if(a.context.storyRef){let n="";if(a.context.panelId){const o=a.context.panelId.replace(/^panel-?/i,"").replace(/^panel/i,"");o&&(n=`?panel=${o}`)}window.location.href=`/stories/${a.context.storyRef}/read${n}`}}}async function C(){const e=I.value.trim();if(!e||a.isLoading)return;const t={role:"user",content:e,timestamp:new Date().toISOString()};a.messages.push(t),h(),I.value="",k.disabled=!0,a.isLoading=!0;const n={role:"ai",content:"...",timestamp:new Date().toISOString()};a.messages.push(n),h(),await f("message_sent",{topicId:a.topicId,messageLength:e.length,hasContext:!!a.context.storyRef});const o=await Z(a.topicId,e,a.context);a.messages.pop(),a.messages.push(o),h(),a.isLoading=!1,k.disabled=!1,F(a.sessionId,{topicId:a.topicId,messages:a.messages,context:a.context,childId:"guest-child",createdAt:a.messages[0]?.timestamp||new Date().toISOString()});const s="child-akhil";try{const r=await j(s,"chat_message",{topicId:a.topicId,messageCount:a.messages.filter(i=>i.role==="user").length,storyRef:a.context.storyRef||null,sourceFeature:"chat_session"});for(const i of r){const u=await V(i.badgeId);u&&W(i.badgeId,u.name,u.icon)}}catch(r){console.warn("[chat] Badge evaluation failed",r)}}async function me(e){if(e)try{const{getStoryById:t}=await S(async()=>{const{getStoryById:o}=await import("./story-services-RJgnPI-H.js");return{getStoryById:o}},__vite__mapDeps([0,1])),n=await t(e);n&&(a.storyTitle=n.title,P())}catch(t){console.warn("[chat] Could not load story title",t)}}async function ge(){if(!b){const n=await G();ue(n),y.classList.remove("hidden"),B.classList.add("hidden");return}y.classList.add("hidden"),B.classList.remove("hidden");const e=await Q(b);if(!e){p.innerHTML=`
      <div class="text-center py-12">
        <p class="text-slate-700 text-lg mb-4">Topic not found. Please go back and select a topic.</p>
        <button onclick="window.location.href='./index.html'" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl font-semibold hover:from-purple-600 hover:to-pink-600 transition">
          Go to Topic List
        </button>
      </div>
    `;return}a.topicId=b,a.topic=e,a.sessionId=te(),ce.textContent=e.name;const t=ee(a.sessionId);if(t&&t.messages)a.messages=t.messages;else{const n={role:"ai",content:`Hi! I'm here to help you learn about ${e.name}! ${e.icon} What would you like to know?`,timestamp:new Date().toISOString()};a.messages=[n]}h(),fe(),P(),a.context.storyRef&&await me(a.context.storyRef),await f("chat_started",{topicId:a.topicId,storyRef:a.context.storyRef,panelId:a.context.panelId}),F(a.sessionId,{topicId:a.topicId,messages:a.messages,context:a.context,childId:"guest-child",createdAt:a.messages[0]?.timestamp||new Date().toISOString()})}k.addEventListener("click",C);I.addEventListener("keypress",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),C())});de.addEventListener("click",async()=>{if(a.sessionId&&a.topicId&&await f("chat_session_ended",{topicId:a.topicId,messageCount:a.messages.length}),a.context.storyRef){let e="";if(a.context.panelId){const t=a.context.panelId.replace(/^panel-?/i,"").replace(/^panel/i,"");t&&(e=`?panel=${t}`)}window.location.href=`/stories/${a.context.storyRef}/read${e}`}else window.location.href="./index.html"});le.addEventListener("click",()=>{f("escalation_clicked",{topicId:a.topicId}),alert("That's a great question! You can ask a parent or teacher for help with this. They'll be happy to explain it to you! ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦")});L();window.addEventListener("online",L);window.addEventListener("offline",L);ge();const N=async()=>{try{const{createClient:e}=await S(async()=>{const{createClient:n}=await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm");return{createClient:n}},[]),{supabaseConfig:t}=await S(async()=>{const{supabaseConfig:n}=await import("./config-N_0HKkEA.js");return{supabaseConfig:n}},[]);if(t?.url&&t?.anonKey){const n=e(t.url,t.anonKey),{error:o}=await n.auth.signOut();if(o)throw o}}catch{console.log("Supabase logout skipped (mock mode)")}localStorage.clear(),sessionStorage.clear(),window.location.href="../auth/auth.html"};document.getElementById("logoutBtn")?.addEventListener("click",N);document.getElementById("logoutBtnMobile")?.addEventListener("click",N);
