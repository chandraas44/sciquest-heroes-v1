import"./config-CMljicwL.js";import{getStoryById as v,getStoryProgressSummary as x,logAnalyticsEvent as C}from"./story-services-CTDJFou-.js";import{_ as E}from"./preload-helper-D7HrI6pR.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const S=new URLSearchParams(window.location.search),r=S.get("storyId"),c=document.getElementById("storyTitle"),d=document.getElementById("storySummary"),f=document.getElementById("storyLongSummary"),g=document.getElementById("storyCover"),L=document.getElementById("storyTopic"),T=document.getElementById("storyReadingLevel"),_=document.getElementById("storyTime"),i=document.getElementById("progressLabel"),l=document.getElementById("startStoryBtn"),s=document.getElementById("resumeStoryBtn"),I=document.getElementById("panelPreview"),b=document.getElementById("panelPreviewTemplate"),R=document.getElementById("openChatBtn");function k(t){I.innerHTML="",t.slice(0,4).forEach((e,n)=>{const o=b.content.cloneNode(!0);o.querySelector("[data-panelId]").textContent=`#${n+1}`,o.querySelector("[data-panelText]").textContent=e.narration,I.appendChild(o)})}function U(t,e){const n=(t==null?void 0:t.lastPanelIndex)>0;!!(t!=null&&t.completedAt)?i.textContent="Completed â€“ great job!":n?i.textContent=`You paused at panel ${Math.min(t.lastPanelIndex+1,e)}.`:i.textContent="You have not started this adventure yet.",s.classList.toggle("hidden",!n),l.textContent=n?"Restart Story":"Start Story"}function $(t,e){var u,h;const n=(e==null?void 0:e.lastPanelIndex)??0,o=Math.min(n,t.length-1),m=(a=0)=>{const P=`/stories/reader.html?storyId=${r}&panel=${a}`;window.location.href=P};l.addEventListener("click",()=>m(0)),s.addEventListener("click",()=>m(o));const y=((u=t[o])==null?void 0:u.chatTopicId)||((h=t[0])==null?void 0:h.chatTopicId);R.addEventListener("click",()=>{const a=new URL("../chat/index.html",window.location.origin);y&&a.searchParams.set("topicId",y),a.searchParams.set("storyRef",r),window.location.href=`${a.pathname}${a.search}`})}async function A(){if(!r){c.textContent="Story not found",d.textContent="Missing story reference. Please return to the story list.",l.disabled=!0;return}try{const t=await v(r);if(!t)throw new Error("Story not found");c.textContent=t.title,d.textContent=t.summary,f.textContent=t.summary,L.textContent=t.topicTag||"Science",T.textContent=t.readingLevel||"Ages 7-10",_.textContent=t.estimatedTime||"6 min read",g.src=t.coverUrl||"/images/placeholder-story.png",g.alt=t.title;const e=t.panels||[];k(e);const n=x(r);U(n,e.length||6),$(e,n),await C("story_detail_opened",{storyId:r,lastPanelIndex:(n==null?void 0:n.lastPanelIndex)??0})}catch(t){console.error("[story-detail] Unable to load story",t),c.textContent="Story unavailable",d.textContent="We could not load this adventure. Please try again later.",l.disabled=!0,s.disabled=!0}}A();const B=async()=>{try{const{createClient:t}=await E(async()=>{const{createClient:n}=await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm");return{createClient:n}},[]),{supabaseConfig:e}=await E(async()=>{const{supabaseConfig:n}=await import("./config-CMljicwL.js");return{supabaseConfig:n}},[]);if(e!=null&&e.url&&(e!=null&&e.anonKey)){const n=t(e.url,e.anonKey),{error:o}=await n.auth.signOut();if(o)throw o}}catch{console.log("Supabase logout skipped (mock mode)")}localStorage.clear(),sessionStorage.clear(),window.location.href="../auth/auth.html"};var w;(w=document.getElementById("logoutBtn"))==null||w.addEventListener("click",B);var p;(p=document.getElementById("logoutBtnMobile"))==null||p.addEventListener("click",B);
