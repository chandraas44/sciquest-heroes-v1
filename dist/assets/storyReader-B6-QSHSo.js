import"./config-ClyacVFi.js";import{logAnalyticsEvent as d,getStoryById as E,getPanelsForStory as x,getStoryProgressSummary as B,saveStoryProgress as C,isUsingStoryMocks as L}from"./story-services-DPdubSP2.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";const g=new URLSearchParams(window.location.search);let t=g.get("storyId");if(!t){const e=window.location.pathname.match(/^\/stories\/([^/]+)\/read$/);e&&(t=e[1])}const s=Number(g.get("panel"))||0,v=document.getElementById("viewerStoryTitle"),T=document.getElementById("panelImage"),b=document.getElementById("panelTag"),w=document.getElementById("panelNarration"),S=document.getElementById("panelPositionLabel"),y=document.getElementById("progressDots"),$=document.getElementById("helperTitle"),k=document.getElementById("helperText"),U=document.getElementById("progressSummary"),h=document.getElementById("chatCtaBtn"),p=document.getElementById("prevPanelBtn"),r=document.getElementById("nextPanelBtn"),N=document.getElementById("openGlossaryBtn"),l=document.getElementById("glossaryDialog"),i=document.getElementById("glossaryList"),M=document.getElementById("closeGlossaryBtn"),I=document.getElementById("viewerOfflineBanner"),n={story:null,panels:[],currentPanelIndex:0,panelCount:0};function c(){if(!I)return;const e=L()||navigator.onLine===!1;I.classList.toggle("hidden",!e)}function _(){y.innerHTML="",n.panels.forEach((e,a)=>{const o=document.createElement("span");o.className="dot"+(a===n.currentPanelIndex?" active":""),o.addEventListener("click",()=>m(a)),y.appendChild(o)})}function A(e=[]){if(i.innerHTML="",!e.length){i.innerHTML='<p class="text-slate-400 text-sm">No glossary terms on this panel.</p>';return}e.forEach(a=>{const o=document.createElement("span");o.className="glossary-pill px-3 py-1 rounded-full bg-slate-100 text-slate-700",o.textContent=a,i.appendChild(o)})}function f(){const e=n.panels[n.currentPanelIndex];e&&(T.src=e.imageUrl||"/images/placeholder-story.png",b.textContent=e.panelId||`Panel ${n.currentPanelIndex+1}`,w.textContent=e.narration,S.textContent=`Panel ${n.currentPanelIndex+1} of ${n.panelCount}`,$.textContent=e.ctaLabel||"Ask a question",k.textContent="Use the chat companion to dig deeper into this scene.",U.textContent=`Panel ${n.currentPanelIndex+1}/${n.panelCount}`,h.textContent=e.ctaLabel||"Ask the AI about this panel",h.onclick=()=>{const a=new URL("../chat/index.html",window.location.origin);e.chatTopicId&&a.searchParams.set("topicId",e.chatTopicId),a.searchParams.set("storyRef",t),a.searchParams.set("panelId",e.panelId??`panel-${n.currentPanelIndex+1}`),window.location.href=`${a.pathname}${a.search}`},p.disabled=n.currentPanelIndex===0,r.disabled=n.currentPanelIndex===n.panelCount-1,_(),A(e.glossaryTerms||[]))}async function u(e=!1){await C({storyId:t,lastPanelIndex:n.currentPanelIndex,completed:e})}async function m(e){var a;if(!(e<0||e>=n.panelCount)){if(n.currentPanelIndex=e,f(),t){const o=`/stories/${t}/read?panel=${e}`;window.history.replaceState({storyId:t,panel:e},"",o)}await u(e===n.panelCount-1),await d("panel_viewed",{storyId:t,panelId:(a=n.panels[e])==null?void 0:a.panelId,panelIndex:e})}}async function D(){if(n.currentPanelIndex>=n.panelCount-1){await u(!0),await d("story_completed",{storyId:t}),r.disabled=!0;return}await m(n.currentPanelIndex+1)}async function F(){n.currentPanelIndex!==0&&await m(n.currentPanelIndex-1)}async function G(){if(!t)throw new Error("storyId missing");const[e,a]=await Promise.all([E(t),x(t)]);if(!e)throw new Error("story not found");if(n.story=e,n.panels=a.length?a:e.panels||[],n.panelCount=n.panels.length,!n.panelCount)throw new Error("story has no panels");v.textContent=e.title;const o=B(t),P=Number.isFinite(s)&&s>=0?s:(o==null?void 0:o.lastPanelIndex)||0;n.currentPanelIndex=Math.min(P,n.panelCount-1)}function H(){r.addEventListener("click",D),p.addEventListener("click",F),N.addEventListener("click",()=>{l&&l.showModal()}),M.addEventListener("click",()=>l==null?void 0:l.close())}async function R(){try{if(c(),window.addEventListener("online",c),window.addEventListener("offline",c),await G(),H(),f(),t&&window.location.pathname!==`/stories/${t}/read`){const e=`/stories/${t}/read?panel=${n.currentPanelIndex}`;window.history.replaceState({storyId:t,panel:n.currentPanelIndex},"",e)}await u(),await d("story_viewer_opened",{storyId:t,panelIndex:n.currentPanelIndex})}catch(e){console.error("[story-viewer] Failed to initialize viewer",e),w.textContent="Unable to load this story. Please head back to the story list.",r.disabled=!0,p.disabled=!0}}R();
