import{createClient as h}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm";import{supabaseConfig as b}from"./config-N_0HKkEA.js";const u={},X=u?.VITE_EDGE_ANALYTICS_URL||"",S=(u?.VITE_USE_BADGES_MOCKS??"true")==="true",s="sqh_badge_awards_v1",y="sqh_analytics_queue_v1";let Z=null,n=null,t=null;function m(){return!!(b?.url&&b?.anonKey)}function N(){return m()?(Z||(Z=h(b.url,b.anonKey)),Z):null}function w(){return S?!0:!m()}async function r(){if(n)return n;const I=await fetch(new URL("data:application/json;base64,ew0KICAiYmFkZ2VzIjogWw0KICAgIHsNCiAgICAgICJpZCI6ICJmaXJzdC1jdXJpb3VzLXF1ZXN0aW9uIiwNCiAgICAgICJuYW1lIjogIkZpcnN0IEN1cmlvdXMgUXVlc3Rpb24iLA0KICAgICAgImRlc2NyaXB0aW9uIjogIkFzayB5b3VyIGZpcnN0IHF1ZXN0aW9uIGluIGNoYXQiLA0KICAgICAgImljb24iOiAi8J+SrSIsDQogICAgICAiaGludCI6ICJBc2sgMSBxdWVzdGlvbiBpbiBjaGF0IiwNCiAgICAgICJjYXRlZ29yeSI6ICJjaGF0IiwNCiAgICAgICJyYXJpdHkiOiAiY29tbW9uIg0KICAgIH0sDQogICAgew0KICAgICAgImlkIjogInBob3Rvc3ludGhlc2lzLWV4cGxvcmVyIiwNCiAgICAgICJuYW1lIjogIlBob3Rvc3ludGhlc2lzIEV4cGxvcmVyIiwNCiAgICAgICJkZXNjcmlwdGlvbiI6ICJDb21wbGV0ZSBhbGwgc3RvcmllcyBhYm91dCBwaG90b3N5bnRoZXNpcyIsDQogICAgICAiaWNvbiI6ICLwn4yxIiwNCiAgICAgICJoaW50IjogIkNvbXBsZXRlIHlvdXIgZmlyc3Qgc2NpZW5jZSBzdG9yeSBhYm91dCBwbGFudHMiLA0KICAgICAgImNhdGVnb3J5IjogInN0b3JpZXMiLA0KICAgICAgInJhcml0eSI6ICJjb21tb24iDQogICAgfSwNCiAgICB7DQogICAgICAiaWQiOiAicXVpei1oZXJvIiwNCiAgICAgICJuYW1lIjogIlF1aXogSGVybyIsDQogICAgICAiZGVzY3JpcHRpb24iOiAiU2NvcmUgODAlIG9yIGhpZ2hlciBvbiBhbnkgcXVpeiIsDQogICAgICAiaWNvbiI6ICLwn4+GIiwNCiAgICAgICJoaW50IjogIlNjb3JlIDgwJSsgb24gYSBxdWl6IiwNCiAgICAgICJjYXRlZ29yeSI6ICJxdWl6emVzIiwNCiAgICAgICJyYXJpdHkiOiAidW5jb21tb24iDQogICAgfSwNCiAgICB7DQogICAgICAiaWQiOiAic3RvcnktbWFzdGVyIiwNCiAgICAgICJuYW1lIjogIlN0b3J5IE1hc3RlciIsDQogICAgICAiZGVzY3JpcHRpb24iOiAiQ29tcGxldGUgNSBzdG9yaWVzIiwNCiAgICAgICJpY29uIjogIvCfk5oiLA0KICAgICAgImhpbnQiOiAiQ29tcGxldGUgNSBzdG9yaWVzIiwNCiAgICAgICJjYXRlZ29yeSI6ICJzdG9yaWVzIiwNCiAgICAgICJyYXJpdHkiOiAicmFyZSINCiAgICB9LA0KICAgIHsNCiAgICAgICJpZCI6ICJzdHJlYWstc3RhciIsDQogICAgICAibmFtZSI6ICJTdHJlYWsgU3RhciIsDQogICAgICAiZGVzY3JpcHRpb24iOiAiTWFpbnRhaW4gYSA3LWRheSBsZWFybmluZyBzdHJlYWsiLA0KICAgICAgImljb24iOiAi4q2QIiwNCiAgICAgICJoaW50IjogIkxlYXJuIGZvciA3IGRheXMgaW4gYSByb3ciLA0KICAgICAgImNhdGVnb3J5IjogInN0cmVha3MiLA0KICAgICAgInJhcml0eSI6ICJyYXJlIg0KICAgIH0NCiAgXSwNCiAgImRlZmF1bHRBd2FyZHMiOiB7DQogICAgImNoaWxkLWFraGlsIjogWyJmaXJzdC1jdXJpb3VzLXF1ZXN0aW9uIl0sDQogICAgImNoaWxkLW1heWEiOiBbImZpcnN0LWN1cmlvdXMtcXVlc3Rpb24iXSwNCiAgICAiY2hpbGQtcnlhbiI6IFsiZmlyc3QtY3VyaW91cy1xdWVzdGlvbiJdDQogIH0NCn0NCg0KDQoNCg==",import.meta.url));if(!I.ok)throw new Error("Unable to load mock badge data");return n=await I.json(),n}async function p(){if(t)return t;if(w()){const C=await fetch(new URL("data:application/json;base64,ew0KICAicnVsZXMiOiBbDQogICAgew0KICAgICAgImlkIjogImZpcnN0LWN1cmlvdXMtcXVlc3Rpb24iLA0KICAgICAgImJhZGdlSWQiOiAiZmlyc3QtY3VyaW91cy1xdWVzdGlvbiIsDQogICAgICAidHJpZ2dlciI6IHsNCiAgICAgICAgInR5cGUiOiAiY2hhdF9tZXNzYWdlIiwNCiAgICAgICAgImNvbmRpdGlvbnMiOiB7DQogICAgICAgICAgImNvdW50IjogMSwNCiAgICAgICAgICAicm9sZSI6ICJ1c2VyIg0KICAgICAgICB9DQogICAgICB9LA0KICAgICAgImV2YWx1YXRpb24iOiB7DQogICAgICAgICJ0eXBlIjogImNvdW50IiwNCiAgICAgICAgInNvdXJjZSI6ICJjaGF0X21lc3NhZ2VzIiwNCiAgICAgICAgImZpbHRlciI6IHsgInJvbGUiOiAidXNlciIgfSwNCiAgICAgICAgInRocmVzaG9sZCI6IDENCiAgICAgIH0sDQogICAgICAicHJpb3JpdHkiOiAxLA0KICAgICAgImRlc2NyaXB0aW9uIjogIlRyaWdnZXJlZCB3aGVuIHVzZXIgc2VuZHMgZmlyc3QgY2hhdCBtZXNzYWdlIg0KICAgIH0sDQogICAgew0KICAgICAgImlkIjogInN0b3J5LW1hc3RlciIsDQogICAgICAiYmFkZ2VJZCI6ICJzdG9yeS1tYXN0ZXIiLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogInN0b3J5X2NvbXBsZXRlZCIsDQogICAgICAgICJjb25kaXRpb25zIjoge30NCiAgICAgIH0sDQogICAgICAiZXZhbHVhdGlvbiI6IHsNCiAgICAgICAgInR5cGUiOiAiY291bnQiLA0KICAgICAgICAic291cmNlIjogInN0b3J5X3Byb2dyZXNzIiwNCiAgICAgICAgImZpbHRlciI6IHsgImNvbXBsZXRlZCI6IHRydWUgfSwNCiAgICAgICAgInRocmVzaG9sZCI6IDUNCiAgICAgIH0sDQogICAgICAicHJpb3JpdHkiOiAyLA0KICAgICAgImRlc2NyaXB0aW9uIjogIlRyaWdnZXJlZCB3aGVuIDUgc3RvcmllcyBjb21wbGV0ZWQiDQogICAgfSwNCiAgICB7DQogICAgICAiaWQiOiAicGhvdG9zeW50aGVzaXMtZXhwbG9yZXIiLA0KICAgICAgImJhZGdlSWQiOiAicGhvdG9zeW50aGVzaXMtZXhwbG9yZXIiLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogInN0b3J5X2NvbXBsZXRlZCIsDQogICAgICAgICJjb25kaXRpb25zIjogew0KICAgICAgICAgICJ0b3BpY1RhZyI6ICJQaG90b3N5bnRoZXNpcyINCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgICJldmFsdWF0aW9uIjogew0KICAgICAgICAidHlwZSI6ICJjb3VudCIsDQogICAgICAgICJzb3VyY2UiOiAic3RvcnlfcHJvZ3Jlc3MiLA0KICAgICAgICAiZmlsdGVyIjogeyAiY29tcGxldGVkIjogdHJ1ZSwgInRvcGljVGFnIjogIlBob3Rvc3ludGhlc2lzIiB9LA0KICAgICAgICAidGhyZXNob2xkIjogMQ0KICAgICAgfSwNCiAgICAgICJwcmlvcml0eSI6IDIsDQogICAgICAiZGVzY3JpcHRpb24iOiAiVHJpZ2dlcmVkIHdoZW4gcGhvdG9zeW50aGVzaXMgc3RvcnkgY29tcGxldGVkIg0KICAgIH0sDQogICAgew0KICAgICAgImlkIjogInF1aXotaGVybyIsDQogICAgICAiYmFkZ2VJZCI6ICJxdWl6LWhlcm8iLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogInF1aXpfY29tcGxldGVkIiwNCiAgICAgICAgImNvbmRpdGlvbnMiOiB7DQogICAgICAgICAgInNjb3JlIjogeyAiZ3RlIjogODAgfQ0KICAgICAgICB9DQogICAgICB9LA0KICAgICAgImV2YWx1YXRpb24iOiB7DQogICAgICAgICJ0eXBlIjogIm1heF9zY29yZSIsDQogICAgICAgICJzb3VyY2UiOiAicXVpel9hdHRlbXB0cyIsDQogICAgICAgICJ0aHJlc2hvbGQiOiA4MA0KICAgICAgfSwNCiAgICAgICJwcmlvcml0eSI6IDIsDQogICAgICAiZGVzY3JpcHRpb24iOiAiVHJpZ2dlcmVkIHdoZW4gcXVpeiBzY29yZSA+PSA4MCUiDQogICAgfSwNCiAgICB7DQogICAgICAiaWQiOiAic3RyZWFrLXN0YXIiLA0KICAgICAgImJhZGdlSWQiOiAic3RyZWFrLXN0YXIiLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogImRhaWx5X2FjdGl2aXR5IiwNCiAgICAgICAgImNvbmRpdGlvbnMiOiB7fQ0KICAgICAgfSwNCiAgICAgICJldmFsdWF0aW9uIjogew0KICAgICAgICAidHlwZSI6ICJzdHJlYWsiLA0KICAgICAgICAic291cmNlIjogImFsbF9hY3Rpdml0aWVzIiwNCiAgICAgICAgInRocmVzaG9sZCI6IDcsDQogICAgICAgICJ1bml0IjogImRheXMiDQogICAgICB9LA0KICAgICAgInByaW9yaXR5IjogMywNCiAgICAgICJkZXNjcmlwdGlvbiI6ICJUcmlnZ2VyZWQgd2hlbiA3LWRheSBzdHJlYWsgYWNoaWV2ZWQiDQogICAgfQ0KICBdDQp9DQoNCg0KDQo=",import.meta.url));if(!C.ok)throw new Error("Unable to load badge rules");return t=(await C.json()).rules||[],t}const I=N();if(!I){const C=await fetch(new URL("data:application/json;base64,ew0KICAicnVsZXMiOiBbDQogICAgew0KICAgICAgImlkIjogImZpcnN0LWN1cmlvdXMtcXVlc3Rpb24iLA0KICAgICAgImJhZGdlSWQiOiAiZmlyc3QtY3VyaW91cy1xdWVzdGlvbiIsDQogICAgICAidHJpZ2dlciI6IHsNCiAgICAgICAgInR5cGUiOiAiY2hhdF9tZXNzYWdlIiwNCiAgICAgICAgImNvbmRpdGlvbnMiOiB7DQogICAgICAgICAgImNvdW50IjogMSwNCiAgICAgICAgICAicm9sZSI6ICJ1c2VyIg0KICAgICAgICB9DQogICAgICB9LA0KICAgICAgImV2YWx1YXRpb24iOiB7DQogICAgICAgICJ0eXBlIjogImNvdW50IiwNCiAgICAgICAgInNvdXJjZSI6ICJjaGF0X21lc3NhZ2VzIiwNCiAgICAgICAgImZpbHRlciI6IHsgInJvbGUiOiAidXNlciIgfSwNCiAgICAgICAgInRocmVzaG9sZCI6IDENCiAgICAgIH0sDQogICAgICAicHJpb3JpdHkiOiAxLA0KICAgICAgImRlc2NyaXB0aW9uIjogIlRyaWdnZXJlZCB3aGVuIHVzZXIgc2VuZHMgZmlyc3QgY2hhdCBtZXNzYWdlIg0KICAgIH0sDQogICAgew0KICAgICAgImlkIjogInN0b3J5LW1hc3RlciIsDQogICAgICAiYmFkZ2VJZCI6ICJzdG9yeS1tYXN0ZXIiLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogInN0b3J5X2NvbXBsZXRlZCIsDQogICAgICAgICJjb25kaXRpb25zIjoge30NCiAgICAgIH0sDQogICAgICAiZXZhbHVhdGlvbiI6IHsNCiAgICAgICAgInR5cGUiOiAiY291bnQiLA0KICAgICAgICAic291cmNlIjogInN0b3J5X3Byb2dyZXNzIiwNCiAgICAgICAgImZpbHRlciI6IHsgImNvbXBsZXRlZCI6IHRydWUgfSwNCiAgICAgICAgInRocmVzaG9sZCI6IDUNCiAgICAgIH0sDQogICAgICAicHJpb3JpdHkiOiAyLA0KICAgICAgImRlc2NyaXB0aW9uIjogIlRyaWdnZXJlZCB3aGVuIDUgc3RvcmllcyBjb21wbGV0ZWQiDQogICAgfSwNCiAgICB7DQogICAgICAiaWQiOiAicGhvdG9zeW50aGVzaXMtZXhwbG9yZXIiLA0KICAgICAgImJhZGdlSWQiOiAicGhvdG9zeW50aGVzaXMtZXhwbG9yZXIiLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogInN0b3J5X2NvbXBsZXRlZCIsDQogICAgICAgICJjb25kaXRpb25zIjogew0KICAgICAgICAgICJ0b3BpY1RhZyI6ICJQaG90b3N5bnRoZXNpcyINCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgICJldmFsdWF0aW9uIjogew0KICAgICAgICAidHlwZSI6ICJjb3VudCIsDQogICAgICAgICJzb3VyY2UiOiAic3RvcnlfcHJvZ3Jlc3MiLA0KICAgICAgICAiZmlsdGVyIjogeyAiY29tcGxldGVkIjogdHJ1ZSwgInRvcGljVGFnIjogIlBob3Rvc3ludGhlc2lzIiB9LA0KICAgICAgICAidGhyZXNob2xkIjogMQ0KICAgICAgfSwNCiAgICAgICJwcmlvcml0eSI6IDIsDQogICAgICAiZGVzY3JpcHRpb24iOiAiVHJpZ2dlcmVkIHdoZW4gcGhvdG9zeW50aGVzaXMgc3RvcnkgY29tcGxldGVkIg0KICAgIH0sDQogICAgew0KICAgICAgImlkIjogInF1aXotaGVybyIsDQogICAgICAiYmFkZ2VJZCI6ICJxdWl6LWhlcm8iLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogInF1aXpfY29tcGxldGVkIiwNCiAgICAgICAgImNvbmRpdGlvbnMiOiB7DQogICAgICAgICAgInNjb3JlIjogeyAiZ3RlIjogODAgfQ0KICAgICAgICB9DQogICAgICB9LA0KICAgICAgImV2YWx1YXRpb24iOiB7DQogICAgICAgICJ0eXBlIjogIm1heF9zY29yZSIsDQogICAgICAgICJzb3VyY2UiOiAicXVpel9hdHRlbXB0cyIsDQogICAgICAgICJ0aHJlc2hvbGQiOiA4MA0KICAgICAgfSwNCiAgICAgICJwcmlvcml0eSI6IDIsDQogICAgICAiZGVzY3JpcHRpb24iOiAiVHJpZ2dlcmVkIHdoZW4gcXVpeiBzY29yZSA+PSA4MCUiDQogICAgfSwNCiAgICB7DQogICAgICAiaWQiOiAic3RyZWFrLXN0YXIiLA0KICAgICAgImJhZGdlSWQiOiAic3RyZWFrLXN0YXIiLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogImRhaWx5X2FjdGl2aXR5IiwNCiAgICAgICAgImNvbmRpdGlvbnMiOiB7fQ0KICAgICAgfSwNCiAgICAgICJldmFsdWF0aW9uIjogew0KICAgICAgICAidHlwZSI6ICJzdHJlYWsiLA0KICAgICAgICAic291cmNlIjogImFsbF9hY3Rpdml0aWVzIiwNCiAgICAgICAgInRocmVzaG9sZCI6IDcsDQogICAgICAgICJ1bml0IjogImRheXMiDQogICAgICB9LA0KICAgICAgInByaW9yaXR5IjogMywNCiAgICAgICJkZXNjcmlwdGlvbiI6ICJUcmlnZ2VyZWQgd2hlbiA3LWRheSBzdHJlYWsgYWNoaWV2ZWQiDQogICAgfQ0KICBdDQp9DQoNCg0KDQo=",import.meta.url));if(!C.ok)throw new Error("Unable to load badge rules");return t=(await C.json()).rules||[],t}try{const{data:C,error:A}=await I.from("badge_rules").select("*").order("priority");if(A)throw A;return t=C||[],t}catch(C){console.warn("[badges] Supabase badge rules fetch failed, reverting to mock data",C);const A=await fetch(new URL("data:application/json;base64,ew0KICAicnVsZXMiOiBbDQogICAgew0KICAgICAgImlkIjogImZpcnN0LWN1cmlvdXMtcXVlc3Rpb24iLA0KICAgICAgImJhZGdlSWQiOiAiZmlyc3QtY3VyaW91cy1xdWVzdGlvbiIsDQogICAgICAidHJpZ2dlciI6IHsNCiAgICAgICAgInR5cGUiOiAiY2hhdF9tZXNzYWdlIiwNCiAgICAgICAgImNvbmRpdGlvbnMiOiB7DQogICAgICAgICAgImNvdW50IjogMSwNCiAgICAgICAgICAicm9sZSI6ICJ1c2VyIg0KICAgICAgICB9DQogICAgICB9LA0KICAgICAgImV2YWx1YXRpb24iOiB7DQogICAgICAgICJ0eXBlIjogImNvdW50IiwNCiAgICAgICAgInNvdXJjZSI6ICJjaGF0X21lc3NhZ2VzIiwNCiAgICAgICAgImZpbHRlciI6IHsgInJvbGUiOiAidXNlciIgfSwNCiAgICAgICAgInRocmVzaG9sZCI6IDENCiAgICAgIH0sDQogICAgICAicHJpb3JpdHkiOiAxLA0KICAgICAgImRlc2NyaXB0aW9uIjogIlRyaWdnZXJlZCB3aGVuIHVzZXIgc2VuZHMgZmlyc3QgY2hhdCBtZXNzYWdlIg0KICAgIH0sDQogICAgew0KICAgICAgImlkIjogInN0b3J5LW1hc3RlciIsDQogICAgICAiYmFkZ2VJZCI6ICJzdG9yeS1tYXN0ZXIiLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogInN0b3J5X2NvbXBsZXRlZCIsDQogICAgICAgICJjb25kaXRpb25zIjoge30NCiAgICAgIH0sDQogICAgICAiZXZhbHVhdGlvbiI6IHsNCiAgICAgICAgInR5cGUiOiAiY291bnQiLA0KICAgICAgICAic291cmNlIjogInN0b3J5X3Byb2dyZXNzIiwNCiAgICAgICAgImZpbHRlciI6IHsgImNvbXBsZXRlZCI6IHRydWUgfSwNCiAgICAgICAgInRocmVzaG9sZCI6IDUNCiAgICAgIH0sDQogICAgICAicHJpb3JpdHkiOiAyLA0KICAgICAgImRlc2NyaXB0aW9uIjogIlRyaWdnZXJlZCB3aGVuIDUgc3RvcmllcyBjb21wbGV0ZWQiDQogICAgfSwNCiAgICB7DQogICAgICAiaWQiOiAicGhvdG9zeW50aGVzaXMtZXhwbG9yZXIiLA0KICAgICAgImJhZGdlSWQiOiAicGhvdG9zeW50aGVzaXMtZXhwbG9yZXIiLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogInN0b3J5X2NvbXBsZXRlZCIsDQogICAgICAgICJjb25kaXRpb25zIjogew0KICAgICAgICAgICJ0b3BpY1RhZyI6ICJQaG90b3N5bnRoZXNpcyINCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgICJldmFsdWF0aW9uIjogew0KICAgICAgICAidHlwZSI6ICJjb3VudCIsDQogICAgICAgICJzb3VyY2UiOiAic3RvcnlfcHJvZ3Jlc3MiLA0KICAgICAgICAiZmlsdGVyIjogeyAiY29tcGxldGVkIjogdHJ1ZSwgInRvcGljVGFnIjogIlBob3Rvc3ludGhlc2lzIiB9LA0KICAgICAgICAidGhyZXNob2xkIjogMQ0KICAgICAgfSwNCiAgICAgICJwcmlvcml0eSI6IDIsDQogICAgICAiZGVzY3JpcHRpb24iOiAiVHJpZ2dlcmVkIHdoZW4gcGhvdG9zeW50aGVzaXMgc3RvcnkgY29tcGxldGVkIg0KICAgIH0sDQogICAgew0KICAgICAgImlkIjogInF1aXotaGVybyIsDQogICAgICAiYmFkZ2VJZCI6ICJxdWl6LWhlcm8iLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogInF1aXpfY29tcGxldGVkIiwNCiAgICAgICAgImNvbmRpdGlvbnMiOiB7DQogICAgICAgICAgInNjb3JlIjogeyAiZ3RlIjogODAgfQ0KICAgICAgICB9DQogICAgICB9LA0KICAgICAgImV2YWx1YXRpb24iOiB7DQogICAgICAgICJ0eXBlIjogIm1heF9zY29yZSIsDQogICAgICAgICJzb3VyY2UiOiAicXVpel9hdHRlbXB0cyIsDQogICAgICAgICJ0aHJlc2hvbGQiOiA4MA0KICAgICAgfSwNCiAgICAgICJwcmlvcml0eSI6IDIsDQogICAgICAiZGVzY3JpcHRpb24iOiAiVHJpZ2dlcmVkIHdoZW4gcXVpeiBzY29yZSA+PSA4MCUiDQogICAgfSwNCiAgICB7DQogICAgICAiaWQiOiAic3RyZWFrLXN0YXIiLA0KICAgICAgImJhZGdlSWQiOiAic3RyZWFrLXN0YXIiLA0KICAgICAgInRyaWdnZXIiOiB7DQogICAgICAgICJ0eXBlIjogImRhaWx5X2FjdGl2aXR5IiwNCiAgICAgICAgImNvbmRpdGlvbnMiOiB7fQ0KICAgICAgfSwNCiAgICAgICJldmFsdWF0aW9uIjogew0KICAgICAgICAidHlwZSI6ICJzdHJlYWsiLA0KICAgICAgICAic291cmNlIjogImFsbF9hY3Rpdml0aWVzIiwNCiAgICAgICAgInRocmVzaG9sZCI6IDcsDQogICAgICAgICJ1bml0IjogImRheXMiDQogICAgICB9LA0KICAgICAgInByaW9yaXR5IjogMywNCiAgICAgICJkZXNjcmlwdGlvbiI6ICJUcmlnZ2VyZWQgd2hlbiA3LWRheSBzdHJlYWsgYWNoaWV2ZWQiDQogICAgfQ0KICBdDQp9DQoNCg0KDQo=",import.meta.url));if(!A.ok)throw new Error("Unable to load badge rules");return t=(await A.json()).rules||[],t}}async function W(){if(w())return(await r()).badges||[];const I=N();if(!I)return(await r()).badges||[];try{const{data:C,error:A}=await I.from("badges").select("*").order("name");if(A)throw A;return C||[]}catch(C){return console.warn("[badges] Supabase badges fetch failed, reverting to mock data",C),(await r()).badges||[]}}async function K(I){if(!I)throw new Error("badgeId is required");return(await W()).find(A=>A.id===I)||null}function J(I){try{return JSON.parse(localStorage.getItem(s)||"{}")[I]||[]}catch(C){return console.warn("[badges] Failed to load badge awards from storage",C),[]}}function V(I,C,A){try{const g=JSON.parse(localStorage.getItem(s)||"{}");if(g[I]||(g[I]=[]),g[I].findIndex(a=>a.badgeId===C)>=0)return;g[I].push({badgeId:C,awardedAt:new Date().toISOString(),context:A}),localStorage.setItem(s,JSON.stringify(g))}catch(g){console.warn("[badges] Failed to save badge award to storage",g)}}function G(I,C){return J(I).some(g=>g.badgeId===C)}function z(I){return J(I)}async function Q(I){try{const A=(await r()).defaultAwards?.[I]||[];if(A.length>0){const g=JSON.parse(localStorage.getItem(s)||"{}");(!g[I]||g[I].length===0)&&(g[I]=A.map(i=>({badgeId:i,awardedAt:new Date().toISOString(),context:{trigger:"default_init"}})),localStorage.setItem(s,JSON.stringify(g)))}}catch(C){console.warn("[badges] Failed to initialize default awards",C)}}async function R(I,C,A){if(G(C,I.badgeId))return{awarded:!1,badgeId:I.badgeId,alreadyAwarded:!0};const g=I.evaluation;if(g.type==="count"){let i=0;if(g.source==="chat_messages")try{const a=JSON.parse(localStorage.getItem("sqh_chat_transcripts_v1")||"{}");i=Object.values(a).flatMap(e=>(e.messages||[]).filter(l=>l.role===g.filter?.role||!0)).length}catch(a){console.warn("[badges] Failed to load chat messages for evaluation",a)}else if(g.source==="story_progress")try{const a=JSON.parse(localStorage.getItem("sqh_story_progress_v1")||"{}");i=Object.values(a).filter(e=>g.filter?.completed!==void 0?e.completed===g.filter.completed:g.filter?.topicTag?e.topicTag===g.filter.topicTag:!0).length}catch(a){console.warn("[badges] Failed to load story progress for evaluation",a)}return i>=g.threshold?{awarded:!0,badgeId:I.badgeId,progress:{current:i,required:g.threshold}}:{awarded:!1,badgeId:I.badgeId,progress:{current:i,required:g.threshold}}}if(g.type==="max_score")return A?.score&&A.score>=g.threshold?{awarded:!0,badgeId:I.badgeId}:{awarded:!1,badgeId:I.badgeId};if(g.type==="streak")try{const i=JSON.parse(localStorage.getItem("sqh_story_progress_v1")||"{}"),a=JSON.parse(localStorage.getItem("sqh_chat_transcripts_v1")||"{}"),o=[...Object.values(i).map(d=>d.lastViewedAt||d.updatedAt),...Object.values(a).flatMap(d=>d.messages?.map(c=>c.timestamp)||[])].filter(Boolean),e=new Date;e.setHours(0,0,0,0);let l=0;for(let d=0;d<g.threshold;d++){const c=new Date(e);c.setDate(c.getDate()-d);const D=c.toISOString().split("T")[0];if(o.some(B=>new Date(B).toISOString().split("T")[0]===D))l++;else if(d>0)break}return l>=g.threshold?{awarded:!0,badgeId:I.badgeId,progress:{current:l,required:g.threshold}}:{awarded:!1,badgeId:I.badgeId,progress:{current:l,required:g.threshold}}}catch(i){return console.warn("[badges] Failed to calculate streak",i),{awarded:!1,badgeId:I.badgeId}}return{awarded:!1,badgeId:I.badgeId}}async function L(I,C,A){await Q(I);const i=(await p()).filter(o=>o.trigger.type===C);i.sort((o,e)=>(o.priority||999)-(e.priority||999));const a=[];for(const o of i){if(G(I,o.badgeId))continue;const e={trigger:C,...A,triggers:A.triggers||[C]},l=await R(o,I,e);l.awarded&&!l.alreadyAwarded&&(await f(I,o.badgeId,e),a.push({badgeId:o.badgeId,awardedAt:new Date().toISOString(),context:e}))}return a}async function f(I,C,A){if(V(I,C,A),!w()&&m()){const g=N();if(g)try{await g.from("badge_awards").insert({user_id:I,badge_id:C,awarded_at:new Date().toISOString(),context:A})}catch(i){console.warn("[badges] Supabase badge award insert failed, stored locally only",i)}}return await j("badge_awarded",{childId:I,badgeId:C,trigger:A.trigger||"unknown",sourceFeature:A.sourceFeature||"badge_system"}),{badgeId:C,awardedAt:new Date().toISOString(),context:A}}async function k(I){await Q(I);const C=await W(),A=J(I),g=new Set(A.map(a=>a.badgeId));return C.map(a=>{const o=A.find(e=>e.badgeId===a.id);return{...a,unlocked:g.has(a.id),awardedAt:o?.awardedAt||null,progress:null}})}async function F(I,C){const A=(await p()).find(i=>i.badgeId===C);return A&&(await R(A,I,{})).progress||null}function j(I,C={}){const A={event_name:I,event_data:{...C,timestamp:new Date().toISOString(),source:"badge_system"},timestamp:new Date().toISOString(),source:"badge_system"};try{const g=JSON.parse(localStorage.getItem(y)||"[]");g.push(A),localStorage.setItem(y,JSON.stringify(g))}catch(g){console.warn("[badges] Failed to queue analytics event",g)}X&&m()&&fetch(X,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A)}).catch(g=>{console.warn("[badges] Analytics send failed, queued only",g)})}export{f as awardBadge,G as checkBadgeAward,L as evaluateBadgeRules,z as getBadgeAwards,K as getBadgeById,F as getBadgeProgress,k as getChildBadges,W as loadBadgeCatalog,j as logBadgeEvent};
